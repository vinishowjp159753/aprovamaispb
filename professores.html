<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Professores - AprovaMaisPB</title>
  <link rel="stylesheet" href="./assets/css/style.css" />
  <style>
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(100%);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    .notification.success {
      background: #28a745;
    }
    .notification.error {
      background: #dc3545;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-badge.pendente {
      background: #ffc107;
      color: #000;
    }
    .status-badge.confirmado {
      background: #28a745;
      color: #fff;
    }
    .status-badge.cancelado {
      background: #dc3545;
      color: #fff;
    }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand">
        <img src="./assets/img/logo_aprovamaispb.png" alt="Logo" />
        <span>AprovaMaisPB</span>
      </div>
      <ul class="menu">
        <li><a href="index.html">Início</a></li>
        <li><a href="matricula.html">Matricule-se</a></li>
        <li><a href="professores.html">Professores</a></li>
        <li><a href="login.html">Dashboard</a></li>
      </ul>
      <button class="hamburger" aria-label="menu" onclick="toggleMenu()">☰</button>
    </nav>
  </header>

  <main class="prof-login">
    <h1>Login do Professor</h1>
    <div class="form-card small">
      <form id="prof-login-form">
        <div class="input-group">
          <label for="prof-user">Usuário</label>
          <input id="prof-user" required />
        </div>
        <div class="input-group">
          <label for="prof-pass">Senha</label>
          <input id="prof-pass" type="password" required />
        </div>
        <div class="actions">
          <button type="submit" class="btn-modern">Entrar</button>
        </div>
        <div id="prof-msg" class="msg"></div>
      </form>
    </div>

    <div id="prof-panel" class="panel" style="display:none">
      <h2>Bem-vindo, Professor</h2>
      <div id="prof-info"></div>
      <div class="actions">
        <button onclick="location.reload()" class="btn-modern outline">Sair</button>
      </div>
    </div>
  </main>

<script type="module">
  // Importar funções do Firebase
  import { 
    autenticarProfessor, 
    buscarTurmasProfessor, 
    buscarInscricoesPorTurma 
  } from "./assets/js/firebase.js";

  // Função para mostrar notificação
  function mostrarNotificacao(mensagem, tipo = "success") {
    // Criar elemento de notificação
    const notification = document.createElement('div');
    notification.className = `notification ${tipo}`;
    notification.innerHTML = `
      <span>${mensagem}</span>
      <button onclick="this.parentElement.remove()">×</button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 5000);
  }

  // Professores login - CORREÇÃO AQUI
  const profForm = document.getElementById('prof-login-form');
  if(profForm){
    profForm.addEventListener('submit', async e => {
      e.preventDefault();
      const u = document.getElementById('prof-user').value;
      const p = document.getElementById('prof-pass').value;
      const msgElement = document.getElementById('prof-msg');
      
      if (!u || !p) {
        msgElement.textContent = 'Preencha todos os campos.';
        msgElement.style.display = 'block';
        return;
      }
      
      try {
        // Mostrar loading
        const submitBtn = profForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Entrando...';
        submitBtn.disabled = true;
        
        const ok = await autenticarProfessor(u, p);
        
        if(ok){
          msgElement.style.color = 'green';
          msgElement.textContent = 'Login bem-sucedido.';
          msgElement.style.display = 'block';
          document.getElementById('prof-login-form').style.display = 'none';
          document.getElementById('prof-panel').style.display = 'block';
          await carregarPainelProfessor(u);
        } else {
          msgElement.style.color = 'crimson';
          msgElement.textContent = 'Usuário ou senha inválidos.';
          msgElement.style.display = 'block';
          mostrarNotificacao('Credenciais inválidas. Verifique usuário e senha.', 'error');
        }
      } catch (error) {
        console.error("Erro no login do professor:", error);
        msgElement.style.color = 'crimson';
        msgElement.textContent = 'Erro ao conectar com o servidor. Tente novamente.';
        msgElement.style.display = 'block';
        mostrarNotificacao('Erro de conexão. Tente novamente.', 'error');
      } finally {
        // Restaurar botão
        const submitBtn = profForm.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Entrar';
        submitBtn.disabled = false;
      }
    });
  }

  async function carregarPainelProfessor(usuario) {
    try {
      // Mostrar loading
      const profInfo = document.getElementById('prof-info');
      profInfo.innerHTML = '<p>Carregando suas turmas...</p>';
      
      // Buscar turmas designadas para este professor
      const turmas = await buscarTurmasProfessor(usuario);
      
      if (turmas.length > 0) {
        let html = '<h3>Suas Turmas</h3><div class="turma-grid">';
        
        for (const turma of turmas) {
          // Buscar alunos para cada turma
          const alunos = await buscarInscricoesPorTurma(turma.turma);
          
          html += `
            <div class="turma-card">
              <h4>${turma.turma}</h4>
              <p>Designada em: ${new Date(turma.designadoEm).toLocaleDateString('pt-BR')}</p>
              <div class="alunos-list">
                <h5>Alunos (${alunos.length})</h5>
                ${alunos.length > 0 ? 
                  alunos.map(aluno => `
                    <div class="aluno-item">
                      <span>${aluno.name}</span>
                      <span class="status-badge ${aluno.status || 'pendente'}">${aluno.status || 'pendente'}</span>
                    </div>
                  `).join('') : 
                  '<p>Nenhum aluno nesta turma ainda.</p>'
                }
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        profInfo.innerHTML = html;
      } else {
        profInfo.innerHTML = '<p>Nenhuma turma designada no momento.</p>';
      }
    } catch (error) {
      console.error("Erro ao carregar painel do professor:", error);
      document.getElementById('prof-info').innerHTML = '<p>Erro ao carregar informações. Tente novamente.</p>';
      mostrarNotificacao('Erro ao carregar dados. Tente recarregar a página.', 'error');
    }
  }
</script>

<script>
function toggleMenu(){
  document.querySelector('.menu').classList.toggle('open');
}
</script>
</body>
</html>
