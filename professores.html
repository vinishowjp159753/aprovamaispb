<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Área do Professor - AprovaMaisPB</title>

  <!-- CSS -->
  <link rel="stylesheet" href="./assets/css/style.css">
  <link rel="stylesheet" href="./assets/css/professores.css">
  <link rel="stylesheet" href="./assets/css/notification-system.css">
  <link rel="icon" type="image/png" href="./assets/img/logo_aprovamaispb.png" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
  <nav class="nav">
    <div class="brand">
      <img src="./assets/img/logo_aprovamaispb.png" alt="Logo" />
      <span>AprovaMaisPB</span>
    </div>
    <ul class="menu">
      <li><a href="index.html">Início</a></li>
      <li><a href="matricula.html">Matricule-se</a></li>
      <li><a href="professores.html" class="active">Área do Professor</a></li>
      <li><a href="login.html">Login Admin</a></li>
    </ul>
    <button class="hamburger" aria-label="menu" onclick="toggleMenu()">☰</button>
  </nav>
</header>

<!-- LOGIN -->
<div id="login-section" class="main-container">
  <main class="login-container fade-in">
    <h2>👨‍🏫 Área do Professor</h2>
    <p>Entre com suas credenciais de acesso</p>
    
    <form id="login-form">
      <div class="form-group">
        <label for="usuario">📧 Usuário:</label>
        <input type="text" id="usuario" required placeholder="Digite seu usuário">
      </div>
      
      <div class="form-group">
        <label for="senha">🔒 Senha:</label>
        <input type="password" id="senha" required placeholder="Digite sua senha">
      </div>
      
      <div class="error-message" id="login-error" style="display: none;">
        ❌ Usuário ou senha incorretos!
      </div>
      
      <button type="submit" class="btn-modern">
        🚀 Acessar Portal
      </button>
    </form>
    
    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--gray-100); border-radius: var(--radius);">
      <h4 style="color: var(--dark); margin-bottom: 1rem;">💡 Informações Importantes</h4>
      <p style="color: var(--gray-600); margin-bottom: 0.5rem;">• Credenciais fornecidas pela administração</p>
      <p style="color: var(--gray-600); margin-bottom: 0.5rem;">• Em caso de problemas, contate o suporte</p>
      <p style="color: var(--gray-600);">• Acesso restrito aos professores autorizados</p>
    </div>
  </main>
</div>

<!-- PAINEL DO PROFESSOR -->
<div id="professor-panel" class="professor-panel" style="display: none;">
  <!-- Header -->
  <div class="welcome-header">
    <div class="container">
      <h1>Bem-vindo, <span id="professor-name">Professor</span>! 👋</h1>
      <p>Gerencie suas turmas designadas</p>
      <button class="btn-modern" onclick="fazerLogout()" style="max-width: 200px; margin: 0 auto;">
        🚪 Sair do Sistema
      </button>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="dashboard-grid">
    <div class="stats-card fade-in">
      <div class="stats-number" id="total-alunos">0</div>
      <div class="stats-label">👥 Total de Alunos</div>
    </div>
    
    <div class="stats-card fade-in">
      <div class="stats-number" id="total-turmas">0</div>
      <div class="stats-label">🏫 Turmas Designadas</div>
    </div>
    
    <div class="stats-card fade-in">
      <div class="stats-number" id="alunos-ativos">0</div>
      <div class="stats-label">✅ Alunos Ativos</div>
    </div>
  </div>

  <!-- Turmas -->
  <div class="container">
    <h2 style="color: var(--dark); margin-bottom: 1rem;">📚 Minhas Turmas Designadas</h2>
    <p style="color: var(--gray-600); margin-bottom: 2rem;">Turmas sob sua responsabilidade</p>
    
    <div class="turmas-container" id="turmas-list">
      <div class="loading-state">
        <div style="text-align: center; padding: 3rem; color: var(--gray-600);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">⏳</div>
          <h3>Carregando turmas...</h3>
          <p>Aguarde enquanto buscamos suas designações</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Suporte -->
  <div class="container">
    <div class="support-section fade-in">
      <h3>📞 Precisa de Ajuda?</h3>
      <p>Nossa equipe de suporte está sempre disponível para ajudar você</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
        <div>
          <strong>📱 Telefone:</strong><br>
          (83) 99999-9999
        </div>
        <div>
          <strong>✉️ Email:</strong><br>
          suporte@aprovamaispb.com
        </div>
        <div>
          <strong>🕒 Horário:</strong><br>
          08:00 - 18:00 (Seg-Sex)
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script type="module" src="./assets/js/firebase-config.js"></script>
<script type="module" src="./assets/js/firebase-integration.js"></script>
<script type="module" src="./assets/js/professores-auth.js"></script>
<script src="./assets/js/notification-system.js"></script>

<script>
  // LOGIN
  document.getElementById('login-form').addEventListener('submit', async function(e){
    e.preventDefault();
    const usuario = document.getElementById('usuario').value;
    const senha = document.getElementById('senha').value;
    const errorElement = document.getElementById('login-error');
    errorElement.style.display = 'none';

    try {
      const logado = await window.professoresAuth.autenticarProfessor(usuario, senha);
      if(logado){
        document.getElementById('login-section').style.display='none';
        document.getElementById('professor-panel').style.display='block';
        
        const professor = window.professoresAuth.getProfessorLogado();
        document.getElementById('professor-name').textContent = professor.nome;
        
        await carregarDadosProfessor(professor.id);
      } else {
        errorElement.style.display='block';
      }
    } catch(err){ 
      console.error('Erro no login:', err); 
      errorElement.style.display='block'; 
    }
  });

  // CARREGAR TURMAS REAIS DA COLEÇÃO DESIGNACOES
  async function carregarDadosProfessor(professorId){
    try{
      // Buscar turmas designadas ao professor
      const turmasDesignadas = await window.professoresAuth.buscarTurmasProfessor(professorId);
      document.getElementById('total-turmas').textContent = turmasDesignadas.length;
      
      let totalAlunos = 0;
      let alunosAtivos = 0;
      const turmasContainer = document.getElementById('turmas-list');
      
      if (turmasDesignadas.length === 0) {
        turmasContainer.innerHTML = `
          <div style="text-align:center; padding:3rem; color:var(--gray-600); width:100%;">
            <div style="font-size:4rem; margin-bottom:1rem;">📚</div>
            <h3>Nenhuma turma designada</h3>
            <p>Entre em contato com a administração para ser designado a uma turma</p>
          </div>
        `;
        return;
      }
      
      turmasContainer.innerHTML = '';

      for(const turma of turmasDesignadas){
        // Buscar alunos específicos desta turma
        const alunos = await window.professoresAuth.buscarAlunosPorTurma(turma.turma);
        totalAlunos += alunos.length;
        alunosAtivos += alunos.filter(a => a.status === 'ativo').length;

        const turmaHTML = `
          <div class="turma-card fade-in">
            <div class="turma-header">
              <div class="turma-title">${turma.turma}</div>
              <div class="turma-badge">${alunos.length} alunos</div>
            </div>
            <div class="turma-info">
              <p><strong>Disciplina:</strong> ${turma.disciplina || 'Não informada'}</p>
              <p><strong>Período:</strong> ${turma.periodo || 'Não informado'}</p>
            </div>
            <h4>👥 Lista de Alunos (${alunos.length})</h4>
            
            ${alunos.length > 0 ? `
              <ul class="aluno-list">
                ${alunos.slice(0, 5).map(aluno => `
                  <li class="aluno-item">
                    <div class="aluno-info">
                      <span class="aluno-name">${aluno.nome}</span>
                      <span class="aluno-contact">
                        📱 ${aluno.telefone} | 
                        <span class="status-badge status-${aluno.status}">${aluno.status}</span>
                        ${aluno.usuario ? '| 👤 ' + aluno.usuario : ''}
                      </span>
                    </div>
                    <button class="btn-small" onclick="contatarAluno('${aluno.telefone}')" title="Contatar aluno">
                      📞
                    </button>
                  </li>
                `).join('')}
              </ul>
              ${alunos.length > 5 ? `<p style="text-align:center; margin-top:1rem; color:var(--gray-600);">+ ${alunos.length - 5} outros alunos</p>` : ''}
            ` : `
              <p style="text-align:center; color:var(--gray-600); padding:2rem;">Nenhum aluno matriculado nesta turma</p>
            `}
            
            <!-- BOTÃO DE DOWNLOAD ADICIONADO -->
            <div style="display: flex; gap: 10px; margin-top: 1rem;">
              <button class="btn-small" onclick="baixarListaTurma('${turma.turma}')" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;">
                💾 Baixar Lista CSV
              </button>
              <button class="btn-small" onclick="visualizarTodosAlunos('${turma.turma}')" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;">
                👁️ Ver Todos
              </button>
            </div>
          </div>
        `;
        turmasContainer.innerHTML += turmaHTML;
      }

      document.getElementById('total-alunos').textContent = totalAlunos;
      document.getElementById('alunos-ativos').textContent = alunosAtivos;
      
    } catch(err){ 
      console.error('Erro ao carregar dados:', err);
      if (window.notifications) {
        window.notifications.error('Erro ao carregar turmas designadas');
      }
    }
  }

  function contatarAluno(telefone){ 
    if (telefone) {
      const numeroLimpo = telefone.replace(/\D/g, '');
      window.open(`https://wa.me/55${numeroLimpo}`, '_blank');
    }
  }

  // FUNÇÃO DE DOWNLOAD CORRIGIDA
  async function baixarListaTurma(turma){
    try {
      const alunos = await window.professoresAuth.buscarAlunosPorTurma(turma);
      if(alunos.length === 0){ 
        if (window.notifications) {
          window.notifications.error('Nenhum aluno encontrado nesta turma');
        }
        return; 
      }

      let csv = 'Nome,Email,Telefone,Usuário,Status,Matéria,Turma,Data Inscrição\n';
      alunos.forEach(aluno => { 
        csv += `"${aluno.nome}","${aluno.email}","${aluno.telefone}","${aluno.usuario}","${aluno.status}","${aluno.materia}","${aluno.turma}","${aluno.criadoEm}"\n`; 
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Turma_${turma.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      if (window.notifications) {
        window.notifications.success('Lista baixada com sucesso!');
      }
    } catch (error) {
      console.error('Erro ao baixar lista:', error);
      if (window.notifications) {
        window.notifications.error('Erro ao baixar lista de alunos');
      }
    }
  }

  function visualizarTodosAlunos(turma) {
    alert(`Visualizar todos os alunos da turma: ${turma}\n\nEsta funcionalidade pode ser expandida para mostrar uma modal com a lista completa.`);
  }

  function fazerLogout(){
    window.professoresAuth.logout();
    window.location.reload();
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (window.professoresAuth && window.professoresAuth.isProfessorLogado()) {
      const professor = window.professoresAuth.getProfessorLogado();
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('professor-panel').style.display = 'block';
      document.getElementById('professor-name').textContent = professor.nome;
      carregarDadosProfessor(professor.id);
    }
  });

  function toggleMenu(){ 
    document.querySelector('.menu').classList.toggle('open'); 
  }
</script>

</body>
</html>
