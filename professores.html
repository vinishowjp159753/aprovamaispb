<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ãrea do Professor - AprovaMaisPB</title>

  <!-- CSS -->
  <link rel="stylesheet" href="./assets/css/style.css">
  <link rel="stylesheet" href="./assets/css/professores.css">
  <link rel="stylesheet" href="./assets/css/notification-system.css">
  <link rel="icon" type="image/png" href="./assets/img/logo_aprovamaispb.png" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
  <nav class="nav">
    <div class="brand">
      <img src="./assets/img/logo_aprovamaispb.png" alt="Logo" />
      <span>AprovaMaisPB</span>
    </div>
    <ul class="menu">
      <li><a href="index.html">InÃ­cio</a></li>
      <li><a href="matricula.html">Matricule-se</a></li>
      <li><a href="professores.html" class="active">Ãrea do Professor</a></li>
      <li><a href="login.html">Login Admin</a></li>
    </ul>
    <button class="hamburger" aria-label="menu" onclick="toggleMenu()">â˜°</button>
  </nav>
</header>

<!-- LOGIN -->
<div id="login-section" class="main-container">
  <main class="login-container fade-in">
    <h2>ğŸ‘¨â€ğŸ« Ãrea do Professor</h2>
    <p>Entre com suas credenciais de acesso</p>
    
    <form id="login-form">
      <div class="form-group">
        <label for="usuario">ğŸ“§ UsuÃ¡rio:</label>
        <input type="text" id="usuario" required placeholder="Digite seu usuÃ¡rio">
      </div>
      
      <div class="form-group">
        <label for="senha">ğŸ”’ Senha:</label>
        <input type="password" id="senha" required placeholder="Digite sua senha">
      </div>
      
      <div class="error-message" id="login-error" style="display: none;">
        âŒ UsuÃ¡rio ou senha incorretos!
      </div>
      
      <button type="submit" class="btn-modern">
        ğŸš€ Acessar Portal
      </button>
    </form>
    
    <div class="support-info">
      <h4>ğŸ’¡ InformaÃ§Ãµes Importantes</h4>
      <p>â€¢ Credenciais fornecidas pela administraÃ§Ã£o</p>
      <p>â€¢ Em caso de problemas, contate o suporte</p>
      <p>â€¢ Acesso restrito aos professores autorizados</p>
    </div>
  </main>
</div>

<!-- PAINEL DO PROFESSOR -->
<div id="professor-panel" class="professor-panel" style="display: none;">
  <!-- Header -->
  <div class="welcome-header">
    <div class="container">
      <h1>Bem-vindo, <span id="professor-name">Professor</span>! ğŸ‘‹</h1>
      <p>Gerencie suas turmas e alunos de <span id="professor-materia" class="materia-badge"></span></p>
      <button class="btn-modern" onclick="fazerLogout()" style="max-width: 200px; margin: 0 auto;">
        ğŸšª Sair do Sistema
      </button>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="dashboard-grid">
    <div class="stats-card fade-in">
      <div class="stats-number" id="total-alunos">0</div>
      <div class="stats-label">ğŸ‘¥ Total de Alunos</div>
    </div>
    
    <div class="stats-card fade-in">
      <div class="stats-number" id="total-turmas">0</div>
      <div class="stats-label">ğŸ« Turmas Ativas</div>
    </div>
    
    <div class="stats-card fade-in">
      <div class="stats-number" id="alunos-ativos">0</div>
      <div class="stats-label">âœ… Alunos Ativos</div>
    </div>
  </div>

  <!-- Turmas -->
  <div class="container">
    <h2 style="color: var(--dark); margin-bottom: 1rem;">ğŸ“š Minhas Turmas</h2>
    <p style="color: var(--gray-600); margin-bottom: 2rem;">Gerencie os alunos da disciplina de <strong id="materia-titulo"></strong></p>
    
    <div class="turmas-container" id="turmas-list">
      <div class="loading-state">
        <div style="text-align: center; padding: 3rem; color: var(--gray-600);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">â³</div>
          <h3>Carregando turmas...</h3>
          <p>Aguarde enquanto buscamos suas informaÃ§Ãµes</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Suporte -->
  <div class="container">
    <div class="support-section fade-in">
      <h3>ğŸ“ Precisa de Ajuda?</h3>
      <p>Nossa equipe de suporte estÃ¡ sempre disponÃ­vel para ajudar vocÃª</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
        <div>
          <strong>ğŸ“± Telefone:</strong><br>
          (83) 99999-9999
        </div>
        <div>
          <strong>âœ‰ï¸ Email:</strong><br>
          suporte@aprovamaispb.com
        </div>
        <div>
          <strong>ğŸ•’ HorÃ¡rio:</strong><br>
          08:00 - 18:00 (Seg-Sex)
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script type="module" src="./assets/js/firebase-config.js"></script>
<script type="module" src="./assets/js/firebase-integration.js"></script>
<script type="module" src="./assets/js/professores-auth.js"></script>
<script src="./assets/js/notification-system.js"></script>

<script>
  // [O MESMO JAVASCRIPT ANTERIOR PERMANECE]
  // LOGIN, CARREGAR DADOS, FUNÃ‡Ã•ES, ETC.
  document.getElementById('login-form').addEventListener('submit', async function(e){
    e.preventDefault();
    const usuario = document.getElementById('usuario').value;
    const senha = document.getElementById('senha').value;
    const errorElement = document.getElementById('login-error');
    errorElement.style.display = 'none';

    try {
      const logado = await window.professoresAuth.autenticarProfessor(usuario, senha);
      if(logado){
        document.getElementById('login-section').style.display='none';
        document.getElementById('professor-panel').style.display='block';
        
        const professor = window.professoresAuth.getProfessorLogado();
        document.getElementById('professor-name').textContent = professor.nome;
        document.getElementById('professor-materia').textContent = professor.materia;
        document.getElementById('materia-titulo').textContent = professor.materia;
        
        await carregarDadosProfessor(professor.id, professor.materia);
      } else {
        errorElement.style.display='block';
      }
    } catch(err){ 
      console.error('Erro no login:', err); 
      errorElement.style.display='block'; 
    }
  });

  async function carregarDadosProfessor(professorId, materiaProfessor){
    try{
      const turmas = await window.professoresAuth.buscarTurmasProfessor(professorId, materiaProfessor);
      document.getElementById('total-turmas').textContent = turmas.length;
      
      let totalAlunos = 0;
      let alunosAtivos = 0;
      const turmasContainer = document.getElementById('turmas-list');
      
      if (turmas.length === 0) {
        turmasContainer.innerHTML = `
          <div style="text-align:center; padding:3rem; color:var(--gray-600); width:100%;">
            <div style="font-size:4rem; margin-bottom:1rem;">ğŸ“š</div>
            <h3>Nenhum aluno encontrado</h3>
            <p>Os alunos aparecerÃ£o aqui quando se matricularem na sua matÃ©ria</p>
          </div>
        `;
        return;
      }
      
      turmasContainer.innerHTML = '';

      for(const turma of turmas){
        const alunos = await window.professoresAuth.buscarAlunosPorMateria(materiaProfessor, turma.turma);
        totalAlunos += alunos.length;
        alunosAtivos += alunos.filter(a => a.status === 'ativo').length;

        const turmaHTML = `
          <div class="turma-card fade-in">
            <div class="turma-header">
              <div class="turma-title">${turma.turma || 'Turma Geral'}</div>
              <div class="turma-badge">${alunos.length} alunos</div>
            </div>
            <div class="turma-info">
              <p><strong>MatÃ©ria:</strong> ${materiaProfessor}</p>
              <p><strong>Alunos ativos:</strong> ${alunos.filter(a => a.status === 'ativo').length}</p>
            </div>
            <h4>ğŸ‘¥ Alunos (${alunos.length})</h4>
            <ul class="aluno-list">
              ${alunos.slice(0, 5).map(aluno => `
                <li class="aluno-item">
                  <div class="aluno-info">
                    <span class="aluno-name">${aluno.nome}</span>
                    <span class="aluno-contact">
                      ğŸ“± ${aluno.telefone} | 
                      <span class="status-badge status-${aluno.status}">${aluno.status}</span>
                    </span>
                  </div>
                  <button class="btn-small" onclick="contatarAluno('${aluno.telefone}')">ğŸ“ Contatar</button>
                </li>
              `).join('')}
            </ul>
            ${alunos.length > 5 ? `<p style="text-align:center; margin-top:1rem; color:var(--gray-600);">+ ${alunos.length - 5} outros alunos</p>` : ''}
            <button class="btn-small" onclick="baixarLista('${materiaProfessor}', '${turma.turma}')" style="margin-top:1rem; width:100%;">
              ğŸ’¾ Baixar Lista Completa (CSV)
            </button>
          </div>
        `;
        turmasContainer.innerHTML += turmaHTML;
      }

      document.getElementById('total-alunos').textContent = totalAlunos;
      document.getElementById('alunos-ativos').textContent = alunosAtivos;
      
    } catch(err){ 
      console.error('Erro ao carregar dados:', err);
    }
  }

  function contatarAluno(telefone){ 
    if (telefone) {
      const numeroLimpo = telefone.replace(/\D/g, '');
      window.open(`https://wa.me/55${numeroLimpo}`, '_blank');
    }
  }

  function fazerLogout(){
    window.professoresAuth.logout();
    window.location.reload();
  }

  async function baixarLista(materia, turma){
    try {
      const alunos = await window.professoresAuth.buscarAlunosPorMateria(materia, turma);
      if(alunos.length === 0) return; 

      let csv = 'Nome,Email,Telefone,UsuÃ¡rio,Status,MatÃ©ria,Turma,Data InscriÃ§Ã£o\n';
      alunos.forEach(aluno => { 
        csv += `"${aluno.nome}","${aluno.email}","${aluno.telefone}","${aluno.usuario}","${aluno.status}","${aluno.materia}","${aluno.turma}","${aluno.criadoEm}"\n`; 
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const nomeArquivo = turma ? `Turma_${turma}_${materia}` : `Alunos_${materia}`;
      a.download = `${nomeArquivo.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
    } catch (error) {
      console.error('Erro ao baixar lista:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (window.professoresAuth && window.professoresAuth.isProfessorLogado()) {
      const professor = window.professoresAuth.getProfessorLogado();
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('professor-panel').style.display = 'block';
      document.getElementById('professor-name').textContent = professor.nome;
      document.getElementById('professor-materia').textContent = professor.materia;
      document.getElementById('materia-titulo').textContent = professor.materia;
      carregarDadosProfessor(professor.id, professor.materia);
    }
  });

  function toggleMenu(){ 
    document.querySelector('.menu').classList.toggle('open'); 
  }
</script>

</body>
</html>
