<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista de Alunos - AprovaMaisPB</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* --- Seu CSS existente --- */
:root {
    --primary: #1a2a6c;
    --secondary: #b21f1f;
    --accent: #fdbb2d;
    --light: #f8f9fa;
    --dark: #343a40;
}

* {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
body {background-color:#f5f7fb;color:#333;}
.container {max-width:1200px;margin:0 auto;padding:20px;}
.header {display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding:20px;background:white;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.05);}
.back-btn {display:inline-flex;align-items:center;padding:10px 15px;background:var(--primary);color:white;text-decoration:none;border-radius:5px;font-weight:500;}
.back-btn i {margin-right:8px;}
h1 {color:var(--primary);text-align:center;margin:20px 0;}
.controls {display:flex;justify-content:space-between;margin-bottom:20px;padding:15px;background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.search-box {display:flex;align-items:center;}
.search-box input {padding:10px 15px;border:1px solid #ddd;border-radius:5px;margin-right:10px;width:300px;}
.btn {padding:10px 15px;background:var(--primary);color:white;border:none;border-radius:5px;cursor:pointer;font-weight:500;}
.btn i {margin-right:5px;}
.table-container {background:white;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.05);}
table {width:100%;border-collapse:collapse;}
th,td {padding:15px;text-align:left;border-bottom:1px solid #eee;}
th {background:var(--primary);color:white;font-weight:500;}
tr:hover {background:#f9f9f9;}
.status {padding:5px 10px;border-radius:20px;font-size:12px;font-weight:500;}
.status.ativo {background:#e8f5e9;color:#2e7d32;}
.status.inativo {background:#ffebee;color:#d32f2f;}
.action-btn {padding:5px 10px;margin-right:5px;border:none;border-radius:3px;cursor:pointer;}
.edit-btn {background:#ffc107;color:#000;}
.payment-btn {background:#28a745;color:white;}
.obs-btn {background:#17a2b8;color:white;}
.modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;}
.modal-content {background:white;padding:30px;border-radius:10px;width:500px;max-width:90%;max-height:90vh;overflow-y:auto;}
.modal h2 {margin-bottom:20px;color:var(--primary);}
.form-group {margin-bottom:20px;}
.form-group label {display:block;margin-bottom:5px;font-weight:500;}
.form-group input, .form-group textarea, .form-group select {width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;}
.form-actions {display:flex;justify-content:flex-end;gap:10px;margin-top:20px;}
.payment-history {margin-top:20px;padding:15px;background:#f8f9fa;border-radius:5px;}
.payment-item {display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #ddd;}
.payment-item:last-child {border-bottom:none;}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <a href="dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Voltar ao Dashboard</a>
        <h1>Lista Completa de Alunos</h1>
        <div></div>
    </div>
    <div class="controls">
        <div class="search-box">
            <input type="text" placeholder="Buscar aluno..." id="searchInput">
            <button class="btn" onclick="searchStudents()"><i class="fas fa-search"></i> Buscar</button>
        </div>
        <button class="btn" onclick="exportData()"><i class="fas fa-download"></i> Exportar</button>
    </div>
    <div class="table-container">
        <table id="studentsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Turma</th>
                    <th>Status</th>
                    <th>Valor Pago</th>
                    <th>Observações</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Linhas serão preenchidas pelo Firebase -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modais (editar, pagamento, observação) -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h2>Editar Aluno</h2>
        <div class="form-group">
            <label for="studentName">Nome</label>
            <input type="text" id="studentName">
        </div>
        <div class="form-group">
            <label for="studentClass">Turma</label>
            <select id="studentClass">
                <option>Turma A - Manhã</option>
                <option>Turma B - Tarde</option>
                <option>Turma C - Noite</option>
            </select>
        </div>
        <div class="form-group">
            <label for="studentStatus">Status</label>
            <select id="studentStatus">
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
            </select>
        </div>
        <div class="form-actions">
            <button class="btn" onclick="closeModal('editModal')">Cancelar</button>
            <button class="btn" style="background: var(--primary);" onclick="saveStudent()">Salvar</button>
        </div>
    </div>
</div>

<div class="modal" id="paymentModal">
    <div class="modal-content">
        <h2>Registrar Pagamento</h2>
        <p>Aluno: <strong id="paymentStudentName"></strong></p>
        <div class="form-group">
            <label for="paymentValue">Valor (R$)</label>
            <input type="number" id="paymentValue" step="0.01" min="0" placeholder="0,00">
        </div>
        <div class="form-group">
            <label for="paymentDate">Data do Pagamento</label>
            <input type="date" id="paymentDate">
        </div>
        <div class="form-group">
            <label for="paymentMethod">Método de Pagamento</label>
            <select id="paymentMethod">
                <option value="dinheiro">Dinheiro</option>
                <option value="pix">PIX</option>
                <option value="cartao">Cartão</option>
                <option value="transferencia">Transferência</option>
            </select>
        </div>
        <div class="payment-history" id="paymentHistory">
            <h3>Histórico de Pagamentos</h3>
        </div>
        <div class="form-actions">
            <button class="btn" onclick="closeModal('paymentModal')">Cancelar</button>
            <button class="btn" style="background: var(--primary);" onclick="confirmPayment()">Confirmar Pagamento</button>
        </div>
    </div>
</div>

<div class="modal" id="observationModal">
    <div class="modal-content">
        <h2>Adicionar Observação</h2>
        <p>Aluno: <strong id="observationStudentName"></strong></p>
        <div class="form-group">
            <label for="observationText">Observação</label>
            <textarea id="observationText" rows="4" placeholder="Digite sua observação aqui..."></textarea>
        </div>
        <div class="form-actions">
            <button class="btn" onclick="closeModal('observationModal')">Cancelar</button>
            <button class="btn" style="background: var(--primary);" onclick="saveObservation()">Salvar Observação</button>
        </div>
    </div>
</div>

<script>
// --- Configuração Firebase ---
const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_PROJECT_ID.firebaseapp.com",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_PROJECT_ID.appspot.com",
    messagingSenderId: "SEU_SENDER_ID",
    appId: "SEU_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentStudentId = null;
let currentStudentName = null;

// --- Carregar alunos e atualizar tabela ---
function loadStudents() {
    db.collection('alunos').onSnapshot(snapshot => {
        const tbody = document.querySelector('#studentsTable tbody');
        tbody.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            let valorPago = 0;
            // Somar pagamentos do aluno
            db.collection('pagamentos').where('alunoId', '==', doc.id).get().then(paysnap => {
                paysnap.forEach(payDoc => { valorPago += parseFloat(payDoc.data().valor); });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${doc.id}</td>
                    <td>${data.nome}</td>
                    <td>${data.turma}</td>
                    <td><span class="status ${data.status}">${data.status.charAt(0).toUpperCase()+data.status.slice(1)}</span></td>
                    <td>R$ ${valorPago.toFixed(2)}</td>
                    <td>${data.observacoes || ''}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editStudent('${doc.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn payment-btn" onclick="showPaymentModal('${doc.id}', '${data.nome}')"><i class="fas fa-money-bill"></i></button>
                        <button class="action-btn obs-btn" onclick="showObservationModal('${doc.id}', '${data.nome}')"><i class="fas fa-comment"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });
    });
}

// --- Funções de modal, pagamento e observação (como mostrei antes) ---
function showPaymentModal(studentId, studentName) {
    currentStudentId = studentId;
    currentStudentName = studentName;
    document.getElementById('paymentStudentName').textContent = studentName;
    document.getElementById('paymentValue').value = '';
    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('paymentModal').style.display = 'flex';
    loadPaymentHistory(studentId);
}

function showObservationModal(studentId, studentName) {
    currentStudentId = studentId;
    currentStudentName = studentName;
    document.getElementById('observationStudentName').textContent = studentName;
    document.getElementById('observationText').value = '';
    document.getElementById('observationModal').style.display = 'flex';
}

async function confirmPayment() {
    const value = parseFloat(document.getElementById('paymentValue').value);
    const date = document.getElementById('paymentDate').value;
    const method = document.getElementById('paymentMethod').value;

    if (!value || value <= 0) { alert('Informe um valor válido.'); return; }

    await db.collection('pagamentos').add({
        alunoId: currentStudentId,
        alunoNome: currentStudentName,
        valor: value,
        dataPagamento: new Date(date),
        metodo: method,
        criadoEm: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert(`Pagamento de R$ ${value.toFixed(2)} registrado!`);
    closeModal('paymentModal');
    loadStudents();
}

async function saveObservation() {
    const observationText = document.getElementById('observationText').value;
    if (!observationText) { alert('Digite uma observação.'); return; }

    await db.collection('observacoes').add({
        alunoId: currentStudentId,
        alunoNome: currentStudentName,
        texto: observationText,
        criadoEm: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Observação adicionada!');
    closeModal('observationModal');
    loadStudents();
}

function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
function editStudent(id) { alert('Editar aluno: ' + id); } // Implementar conforme necessidade
function searchStudents() { 
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('#studentsTable tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(searchText) ? '' : 'none';
    });
}
function exportData() { alert('Implementar exportação'); }

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) { event.target.style.display = 'none'; }
};

document.getElementById('searchInput').addEventListener('keypress', function(e){
    if(e.key === 'Enter') searchStudents();
});

// --- Inicializar ---
loadStudents();
</script>
</body>
</html>
