<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Alunos - AprovaMaisPB</title>
    <script type="module" src="assets/js/firebase-config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a2a6c;
            --secondary: #b21f1f;
            --accent: #fdbb2d;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color:#f5f7fb; color:#333; }

        .container { max-width:1200px; margin:0 auto; padding:20px; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding:20px; background:white; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.05);}
        .back-btn { display:inline-flex; align-items:center; padding:10px 15px; background:var(--primary); color:white; text-decoration:none; border-radius:5px; font-weight:500;}
        .back-btn i { margin-right:8px; }
        h1 { color:var(--primary); text-align:center; margin:20px 0; }

        .controls { display:flex; justify-content:space-between; margin-bottom:20px; padding:15px; background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
        .search-box { display:flex; align-items:center; }
        .search-box input { padding:10px 15px; border:1px solid #ddd; border-radius:5px; margin-right:10px; width:300px; }
        .btn { padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer; font-weight:500; }
        .btn i { margin-right:5px; }

        .table-container { background:white; border-radius:10px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.05); }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:15px; text-align:left; border-bottom:1px solid #eee; }
        th { background:var(--primary); color:white; font-weight:500; }
        tr:hover { background:#f9f9f9; }

        .status { padding:5px 10px; border-radius:20px; font-size:12px; font-weight:500; }
        .status.ativo { background:#e8f5e9; color:#2e7d32; }
        .status.inativo { background:#ffebee; color:#d32f2f; }
        .action-btn { padding:5px 10px; margin-right:5px; border:none; border-radius:3px; cursor:pointer; }
        .edit-btn { background:#ffc107; color:#000; }
        .payment-btn { background:#28a745; color:white; }
        .obs-btn { background:#17a2b8; color:white; }
        .delete-btn { background:#d32f2f; color:white; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background:white; padding:30px; border-radius:10px; width:500px; max-width:90%; max-height:90vh; overflow-y:auto; }
        .modal h2 { margin-bottom:20px; color:var(--primary); }
        .form-group { margin-bottom:20px; }
        .form-group label { display:block; margin-bottom:5px; font-weight:500; }
        .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; }
        .form-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
        .payment-history { margin-top:20px; padding:15px; background:#f8f9fa; border-radius:5px; }
        .payment-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #ddd; }
        .payment-item:last-child { border-bottom:none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="dashboard.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
            </a>
            <h1>Lista Completa de Alunos</h1>
            <div></div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" placeholder="Buscar aluno..." id="searchInput">
                <button class="btn" onclick="searchStudents()"><i class="fas fa-search"></i> Buscar</button>
            </div>
            <button class="btn" onclick="exportData()"><i class="fas fa-download"></i> Exportar</button>
        </div>

        <div class="table-container">
            <table id="studentsTable">
                <thead>
                    <tr>
                        <th style="display:none;">ID</th>
                        <th>Nome</th>
                        <th>Turma</th>
                        <th>Número do Pedido</th>
                        <th>Telefone</th>
                        <th>Status</th>
                        <th>Observações</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="studentsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modais -->
    <!-- Editar Status -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h2>Editar Status do Aluno</h2>
            <div class="form-group">
                <label for="studentStatus">Status</label>
                <select id="studentStatus">
                    <option value="pendente">Pendente</option>
                    <option value="ativo">Ativo</option>
                    <option value="inativo">Inativo</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('editModal')">Cancelar</button>
                <button class="btn" style="background: var(--primary);" onclick="saveStudentStatus()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Registrar Pagamento -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <h2>Registrar Pagamento</h2>
            <p>Aluno: <strong id="paymentStudentName"></strong></p>
            <div class="form-group">
                <label for="paymentValue">Valor (R$)</label>
                <input type="number" id="paymentValue" step="0.01" min="0" placeholder="0,00">
            </div>
            <div class="form-group">
                <label for="paymentDate">Data do Pagamento</label>
                <input type="date" id="paymentDate">
            </div>
            <div class="form-group">
                <label for="paymentMethod">Método de Pagamento</label>
                <select id="paymentMethod">
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="cartao">Cartão</option>
                    <option value="transferencia">Transferência</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('paymentModal')">Cancelar</button>
                <button class="btn" style="background: var(--primary);" onclick="confirmPayment()">Confirmar Pagamento</button>
            </div>
        </div>
    </div>

    <!-- Adicionar Observação -->
    <div class="modal" id="observationModal">
        <div class="modal-content">
            <h2>Adicionar Observação</h2>
            <p>Aluno: <strong id="observationStudentName"></strong></p>
            <div class="form-group">
                <label for="observationText">Observação</label>
                <textarea id="observationText" rows="4" placeholder="Digite sua observação..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('observationModal')">Cancelar</button>
                <button class="btn" style="background: var(--primary);" onclick="saveObservation()">Salvar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "./assets/js/firebase-config.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp();
        const db = getFirestore(app);

        let currentStudentId = null;
        let currentStudentName = null;

        async function loadStudents() {
            const tbody = document.getElementById('studentsBody');
            tbody.innerHTML = '';

            const querySnapshot = await getDocs(collection(db, "inscricoes"));
            querySnapshot.forEach(docSnap => {
                const data = docSnap.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="display:none;">${docSnap.id}</td>
                    <td>${data.nomeCompleto || ''}</td>
                    <td>${data.turma || ''}</td>
                    <td>${data.numeroPedido || ''}</td>
                    <td>${data.telefone || ''}</td>
                    <td><span class="status ${data.status === 'ativo' ? 'ativo' : 'inativo'}">${data.status}</span></td>
                    <td>${data.observacoes || ''}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editStudent('${docSnap.id}', '${data.status}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn payment-btn" onclick="showPaymentModal('${docSnap.id}', '${data.nomeCompleto}')"><i class="fas fa-money-bill"></i></button>
                        <button class="action-btn obs-btn" onclick="showObservationModal('${docSnap.id}', '${data.nomeCompleto}')"><i class="fas fa-comment"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteStudent('${docSnap.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editStudent(id, status) {
            currentStudentId = id;
            document.getElementById('studentStatus').value = status;
            document.getElementById('editModal').style.display = 'flex';
        }

        async function saveStudentStatus() {
            const status = document.getElementById('studentStatus').value;
            await updateDoc(doc(db, "inscricoes", currentStudentId), { status });
            closeModal('editModal');
            loadStudents();
        }

        function showPaymentModal(id, name) {
            currentStudentId = id;
            currentStudentName = name;
            document.getElementById('paymentStudentName').textContent = name;
            document.getElementById('paymentValue').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentModal').style.display = 'flex';
        }

        function showObservationModal(id, name) {
            currentStudentId = id;
            currentStudentName = name;
            document.getElementById('observationStudentName').textContent = name;
            document.getElementById('observationText').value = '';
            document.getElementById('observationModal').style.display = 'flex';
        }

        async function saveObservation() {
            const text = document.getElementById('observationText').value;
            await updateDoc(doc(db, "inscricoes", currentStudentId), { observacoes: text });
            closeModal('observationModal');
            loadStudents();
        }

        async function deleteStudent(id) {
            if (confirm("Deseja realmente excluir este aluno?")) {
                await deleteDoc(doc(db, "inscricoes", id));
                loadStudents();
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function searchStudents() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTable tbody tr');
            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const turma = row.cells[2].textContent.toLowerCase();
                const pedido = row.cells[3].textContent.toLowerCase();
                const telefone = row.cells[4].textContent.toLowerCase();
                if (name.includes(searchText) || turma.includes(searchText) || pedido.includes(searchText) || telefone.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function exportData() {
            alert("Funcionalidade de exportação será implementada.");
        }

        document.getElementById('searchInput').addEventListener('keyup', searchStudents);

        loadStudents();
    </script>
</body>
</html>
