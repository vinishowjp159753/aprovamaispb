<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista de Alunos - AprovaMaisPB</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4;}
    h1 { text-align:center; margin:20px 0; }
    table { width:90%; margin:20px auto; border-collapse: collapse; background:#fff;}
    th, td { border:1px solid #ccc; padding:10px; text-align:left;}
    th { background:#1a2a6c; color:#fff; }
    tr:nth-child(even) { background:#f9f9f9; }
    .action-btn { margin-right:5px; cursor:pointer; border:none; padding:5px 8px; border-radius:4px; }
    .edit-btn { background:#1a2a6c; color:#fff; }
    .payment-btn { background:#28a745; color:#fff; }
    .obs-btn { background:#fdba2d; color:#fff; }
    .delete-btn { background:#dc3545; color:#fff; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:20px; border-radius:8px; width:400px; position:relative; }
    .modal-content h3 { margin-top:0; }
    .modal-content input, .modal-content select, .modal-content textarea { width:100%; padding:8px; margin:5px 0 10px 0; }
    .modal-content button { margin-top:10px; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; }
    #searchInput { width:90%; margin:20px auto; display:block; padding:10px; border-radius:4px; border:1px solid #ccc;}
</style>
</head>
<body>

<h1>Lista de Alunos</h1>
<input type="text" id="searchInput" placeholder="Pesquisar aluno...">

<table id="studentsTable">
    <thead>
        <tr>
            <th style="display:none">ID</th>
            <th>Nome</th>
            <th>Turma</th>
            <th>Número do Pedido</th>
            <th>Telefone</th>
            <th>Status</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h3>Editar Aluno</h3>
        <label>Nome</label>
        <input type="text" id="studentName">
        <label>Turma</label>
        <input type="text" id="studentClass">
        <label>Status</label>
        <select id="studentStatus">
            <option value="pendente">Pendente</option>
            <option value="confirmado">Confirmado</option>
            <option value="cancelado">Cancelado</option>
        </select>
        <button onclick="saveStudent()">Salvar</button>
        <button onclick="closeModal('editModal')">Fechar</button>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal" id="paymentModal">
    <div class="modal-content">
        <h3>Registrar Pagamento: <span id="paymentStudentName"></span></h3>
        <label>Valor</label>
        <input type="number" id="paymentValue" min="0">
        <label>Data</label>
        <input type="date" id="paymentDate">
        <label>Método</label>
        <select id="paymentMethod">
            <option value="dinheiro">Dinheiro</option>
            <option value="cartao">Cartão</option>
            <option value="pix">PIX</option>
        </select>
        <button onclick="confirmPayment()">Registrar</button>
        <button onclick="closeModal('paymentModal')">Fechar</button>
    </div>
</div>

<!-- Observation Modal -->
<div class="modal" id="observationModal">
    <div class="modal-content">
        <h3>Adicionar Observação: <span id="observationStudentName"></span></h3>
        <textarea id="observationText" rows="4"></textarea>
        <button onclick="saveObservation()">Salvar</button>
        <button onclick="closeModal('observationModal')">Fechar</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "./assets/js/firebase-config.js";
import { getFirestore, collection, doc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp();
const db = getFirestore(app);

let currentStudentId = null;

async function loadStudents() {
    const tbody = document.querySelector('#studentsTable tbody');
    tbody.innerHTML = '';
    try {
        const snapshot = await getDocs(collection(db, 'inscricoes'));
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="display:none">${docSnap.id}</td>
                <td>${data.nomeCompleto || ''}</td>
                <td>${data.turma || ''}</td>
                <td>${data.numeroPedido || ''}</td>
                <td>${data.telefone || ''}</td>
                <td>${data.status || ''}</td>
                <td>
                    <button class="action-btn edit-btn" onclick="editStudent('${docSnap.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn payment-btn" onclick="showPaymentModal('${docSnap.id}', '${data.nomeCompleto || ''}')"><i class="fas fa-money-bill"></i></button>
                    <button class="action-btn obs-btn" onclick="showObservationModal('${docSnap.id}', '${data.nomeCompleto || ''}')"><i class="fas fa-comment"></i></button>
                    <button class="action-btn delete-btn" onclick="deleteStudent('${docSnap.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error('Erro ao carregar alunos:', err);
    }
}

// Editar
window.editStudent = async function(id) {
    currentStudentId = id;
    const docRef = doc(db, 'inscricoes', id);
    const docSnap = await getDocs(collection(db, 'inscricoes'));
    const data = (await docRef.get()).data();
    document.getElementById('studentName').value = data.nomeCompleto || '';
    document.getElementById('studentClass').value = data.turma || '';
    document.getElementById('studentStatus').value = data.status || '';
    document.getElementById('editModal').style.display = 'flex';
};

window.saveStudent = async function() {
    if (!currentStudentId) return;
    const docRef = doc(db, 'inscricoes', currentStudentId);
    await updateDoc(docRef, {
        nomeCompleto: document.getElementById('studentName').value,
        turma: document.getElementById('studentClass').value,
        status: document.getElementById('studentStatus').value
    });
    closeModal('editModal');
    loadStudents();
};

// Pagamento
window.showPaymentModal = function(id, name) {
    currentStudentId = id;
    document.getElementById('paymentStudentName').textContent = name;
    document.getElementById('paymentValue').value = '';
    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('paymentModal').style.display = 'flex';
};

window.confirmPayment = async function() {
    const value = document.getElementById('paymentValue').value;
    const date = document.getElementById('paymentDate').value;
    const method = document.getElementById('paymentMethod').value;
    if (!value || value <= 0) { alert('Informe um valor válido'); return; }
    const docRef = doc(db, 'inscricoes', currentStudentId);
    await updateDoc(docRef, { valorPago: value });
    alert(`Pagamento de R$ ${value} registrado.`);
    closeModal('paymentModal');
    loadStudents();
};

// Observações
window.showObservationModal = function(id, name) {
    currentStudentId = id;
    document.getElementById('observationStudentName').textContent = name;
    document.getElementById('observationText').value = '';
    document.getElementById('observationModal').style.display = 'flex';
};

window.saveObservation = async function() {
    const obs = document.getElementById('observationText').value;
    if (!obs) { alert('Digite uma observação'); return; }
    const docRef = doc(db, 'inscricoes', currentStudentId);
    await updateDoc(docRef, { observacoes: obs });
    alert('Observação salva!');
    closeModal('observationModal');
    loadStudents();
};

// Excluir
window.deleteStudent = async function(id) {
    if (!confirm('Deseja realmente excluir este aluno?')) return;
    const docRef = doc(db, 'inscricoes', id);
    await deleteDoc(docRef);
    loadStudents();
};

// Modais
window.closeModal = function(modalId) {
    document.getElementById(modalId).style.display = 'none';
};

// Busca
window.searchStudents = function() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#studentsTable tbody tr');
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(searchText) ? '' : 'none';
    });
};

// Fechar modal clicando fora
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
};

// Inicializar
loadStudents();
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchStudents();
});
</script>
</body>
</html>
