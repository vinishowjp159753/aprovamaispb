<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Teste - Camisa Preta (Try-on)</title>
<style>
  :root{
    --accent:#0b61a4;
    --bg:#f5f7fb;
    --card:#fff;
    --muted:#666;
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{margin:0;background:var(--bg);color:#111;padding:28px;}
  .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:380px 1fr;gap:20px;}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(16,24,40,0.06);}
  .product-title{display:flex;align-items:center;gap:12px}
  .product-title h1{margin:0;font-size:20px}
  .price{margin-top:12px;font-weight:700;color:var(--accent);font-size:18px}
  label{display:block;margin-top:12px;font-size:13px;color:var(--muted)}
  select,input[type="number"],button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px;font-size:14px}
  input[type="file"]{margin-top:8px}
  .btn-primary{background:var(--accent);color:#fff;border:none;cursor:pointer}
  .preview-area{display:flex;flex-direction:column;gap:12px}
  .canvas-wrap{background:#e9eef7;border-radius:10px;padding:14px;min-height:520px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;}
  /* preview layout */
  #userPhoto{max-width:100%;max-height:100%;display:block;transform-origin:center center; touch-action:none;}
  #productOverlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);cursor:grab;pointer-events:auto; user-select:none;}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .controls label{display:block;font-size:13px;color:var(--muted)}
  .controls input[type=range]{width:160px}
  .result-image{max-width:100%;border-radius:8px;margin-top:12px}
  .notice{font-size:13px;color:var(--muted);margin-top:8px}
  .small{font-size:12px;color:var(--muted)}
  /* responsive */
  @media(max-width:900px){.container{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <div class="container">
    <!-- left column: product & options -->
    <div class="card">
      <div class="product-title">
        <img src="shirt.png" alt="Camisa Preta" style="width:68px;height:68px;object-fit:contain;border-radius:8px;background:#000"/>
        <div>
          <h1>Camisa Preta - Modelagem Unissex</h1>
          <div class="small">100% algodão | Acabamento Premium</div>
        </div>
      </div>

      <div class="price">R$ 69,90</div>

      <label for="size">Tamanho</label>
      <select id="size">
        <option value="P">P</option>
        <option value="M" selected>M</option>
        <option value="G">G</option>
        <option value="GG">GG</option>
        <option value="XG">XG</option>
      </select>

      <label for="qty">Quantidade</label>
      <input id="qty" type="number" value="1" min="1" />

      <label for="name">Nome (para pedido)</label>
      <input id="name" type="text" placeholder="Seu nome" />

      <hr style="margin:16px 0;border:none;border-top:1px solid #eef2f7"/>

      <label for="userPhotoFile">Upload da sua foto (frente)</label>
      <input id="userPhotoFile" type="file" accept="image/*" />

      <label for="productFile">Imagem do produto (opcional - PNG com fundo transparente para melhor resultado)</label>
      <input id="productFile" type="file" accept="image/*" />

      <div style="margin-top:12px">
        <button id="addCart" class="btn-primary">Adicionar ao carrinho</button>
      </div>

      <div style="margin-top:12px">
        <button id="sendToIA" class="btn-primary" style="background:#2563eb">Testar com IA (Lovart)</button>
      </div>

      <div class="notice">
        <strong>Nota:</strong> Para integração real com a Lovart você vai precisar da <em>chave/endpoint</em> e das especificações da API. Abaixo do código tem instruções de integração.
      </div>
    </div>

    <!-- right column: preview -->
    <div>
      <div class="card preview-area">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Preview — Teste virtual</strong>
          <div class="small">Arraste a camisa para posicionar. Use controles para escalar/rotacionar.</div>
        </div>

        <div class="canvas-wrap" id="canvasWrap">
          <!-- user photo -->
          <img id="userPhoto" src="" alt="Sua foto" style="display:none">
          <!-- overlaid product (inicial shirt.png) -->
          <img id="productOverlay" src="shirt.png" alt="overlay" style="width:260px;display:block;"/>
        </div>

        <div class="controls">
          <div>
            <label>Escala</label>
            <input id="scale" type="range" min="0.2" max="2.0" step="0.01" value="1">
          </div>
          <div>
            <label>Rotação</label>
            <input id="rotate" type="range" min="-180" max="180" step="1" value="0">
          </div>
          <div>
            <label>Opacidade</label>
            <input id="opacity" type="range" min="0.2" max="1" step="0.01" value="0.95">
          </div>
          <div>
            <label>Reset</label>
            <button id="resetBtn">Resetar posição</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="downloadMock" class="btn-primary" style="background:#10b981">Baixar simulação</button>
          <div class="small">ou use "Testar com IA" para enviar para Lovart.</div>
        </div>

        <img id="iaResult" class="result-image" style="display:none" alt="Resultado IA"/>

      </div>
    </div>
  </div>

<script>
/*
  Script para:
  - mostrar preview da foto do usuário
  - sobrepor a imagem do produto com controles de escala/rotação/posição
  - preparar envio para API (Lovart) - função `sendToLovart()` com placeholder
*/

// elementos
const userFile = document.getElementById('userPhotoFile');
const productFile = document.getElementById('productFile');
const userPhoto = document.getElementById('userPhoto');
const productOverlay = document.getElementById('productOverlay');
const canvasWrap = document.getElementById('canvasWrap');

const scaleInput = document.getElementById('scale');
const rotateInput = document.getElementById('rotate');
const opacityInput = document.getElementById('opacity');
const resetBtn = document.getElementById('resetBtn');
const downloadBtn = document.getElementById('downloadMock');
const sendToIAButton = document.getElementById('sendToIA');
const iaResult = document.getElementById('iaResult');

// estado de transform
let state = {
  x: canvasWrap.clientWidth/2,
  y: canvasWrap.clientHeight/2,
  scale: 1,
  rotate: 0,
  dragging: false,
  offsetX:0,
  offsetY:0
};

// carregar foto do usuário
userFile.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  userPhoto.src = url;
  userPhoto.style.display = 'block';
  // ajustar user photo para caber
  userPhoto.onload = () => {
    fitUserPhoto();
  }
});

productFile.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  productOverlay.src = url;
});

// ajuste inicial & controles
function fitUserPhoto(){
  // simples: max width/height do container
  userPhoto.style.maxWidth = '100%';
  userPhoto.style.maxHeight = '100%';
  // reset produto para centro
  state.x = canvasWrap.clientWidth/2;
  state.y = canvasWrap.clientHeight/2;
  applyTransform();
}

function applyTransform(){
  const s = state.scale;
  const r = state.rotate;
  productOverlay.style.transform = `translate(-50%,-50%) translate(${state.x - canvasWrap.clientWidth/2}px, ${state.y - canvasWrap.clientHeight/2}px) scale(${s}) rotate(${r}deg)`;
  productOverlay.style.opacity = opacityInput.value;
}

// controles input
scaleInput.addEventListener('input', e=>{
  state.scale = parseFloat(e.target.value);
  applyTransform();
});
rotateInput.addEventListener('input', e=>{
  state.rotate = parseFloat(e.target.value);
  applyTransform();
});
opacityInput.addEventListener('input', e=>{
  productOverlay.style.opacity = e.target.value;
});

// arrastar overlay
productOverlay.addEventListener('pointerdown', (ev)=>{
  productOverlay.setPointerCapture(ev.pointerId);
  state.dragging = true;
  state.offsetX = ev.clientX - state.x;
  state.offsetY = ev.clientY - state.y;
  productOverlay.style.cursor = 'grabbing';
});
window.addEventListener('pointermove', (ev)=>{
  if(!state.dragging) return;
  state.x = ev.clientX - state.offsetX;
  state.y = ev.clientY - state.offsetY;
  // limitar dentro do canvas
  const rect = canvasWrap.getBoundingClientRect();
  state.x = Math.max(rect.left, Math.min(rect.right, state.x));
  state.y = Math.max(rect.top, Math.min(rect.bottom, state.y));
  applyTransform();
});
window.addEventListener('pointerup', (ev)=>{
  state.dragging = false;
  productOverlay.style.cursor = 'grab';
});

// reset
resetBtn.addEventListener('click', ()=>{
  state.scale = 1;
  state.rotate = 0;
  scaleInput.value = 1;
  rotateInput.value = 0;
  opacityInput.value = 0.95;
  state.x = canvasWrap.clientWidth/2;
  state.y = canvasWrap.clientHeight/2;
  applyTransform();
});

// download mock (gera canvas combinando ambos)
downloadBtn.addEventListener('click', async ()=>{
  // cria canvas com o tamanho do container visível
  const rect = canvasWrap.getBoundingClientRect();
  const w = Math.round(rect.width);
  const h = Math.round(rect.height);
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');

  // desenha fundo branco
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,w,h);

  // desenhar user photo centralizado se existir
  if(userPhoto.src){
    // desenhar mantendo proporção
    const img = userPhoto;
    await ensureImageLoaded(img);
    const ratio = Math.min(w/img.naturalWidth, h/img.naturalHeight);
    const iw = img.naturalWidth * ratio;
    const ih = img.naturalHeight * ratio;
    const ix = (w - iw)/2;
    const iy = (h - ih)/2;
    ctx.drawImage(img, ix, iy, iw, ih);
  }

  // desenhar produto com transform atual
  await ensureImageLoaded(productOverlay);
  // calcular posição produtoOverlay em relação ao canvas center
  const prodImg = productOverlay;
  // obter estilo transform: ler state
  const sw = prodImg.naturalWidth * state.scale;
  const sh = prodImg.naturalHeight * state.scale;
  // produto centralizado por design: productOverlay transforma com translate(-50%,-50%) e position center
  // posição relativa:
  const centerX = w/2 + (state.x - canvasWrap.getBoundingClientRect().left - w/2);
  const centerY = h/2 + (state.y - canvasWrap.getBoundingClientRect().top - h/2);

  ctx.save();
  ctx.translate(centerX, centerY);
  ctx.rotate(state.rotate * Math.PI/180);
  ctx.globalAlpha = parseFloat(opacityInput.value);
  ctx.drawImage(prodImg, -sw/2, -sh/2, sw, sh);
  ctx.restore();

  // baixar
  const dataUrl = c.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = 'simulacao-camisa.png';
  a.click();
});

// util
function ensureImageLoaded(img){
  return new Promise((resolve)=> {
    if(img.complete && img.naturalWidth !== 0) resolve();
    else img.onload = ()=>resolve();
  });
}

/* -------------------------------
  Função de integração com "Lovart"
  (placeholder). Edite os detalhes:
   - LOVART_ENDPOINT: URL fornecida pela Lovart
   - API_KEY: chave de autenticação
   - Formato de resposta: aqui assumimos que a API retorna JSON { "result_base64": "data:image/png;base64,..." }
--------------------------------*/
async function sendToLovart(){
  const userFileObj = userFile.files[0];
  const productFileObj = productFile.files[0];

  if(!userFileObj){
    alert('Por favor envie a foto do usuário antes de testar com IA.');
    return;
  }
  // se não enviou imagem do produto, envia a imagem padrão que está no src do produtoOverlay
  // cria formdata
  const fd = new FormData();
  fd.append('user_image', userFileObj);
  if(productFileObj) fd.append('product_image', productFileObj);
  else {
    // fetch image blob from productOverlay.src
    const blob = await (await fetch(productOverlay.src)).blob();
    fd.append('product_image', blob, 'product.png');
  }

  // parâmetros extras (tamanho, preferências)
  fd.append('size', document.getElementById('size').value);
  fd.append('name', document.getElementById('name').value || '');

  // placeholder endpoint - troque para o real da Lovart
  const LOVART_ENDPOINT = 'https://api.lovart.example/tryon'; // <<-- troque
  const API_KEY = 'COLOQUE_SUA_CHAVE_AQUI'; // <<-- troque

  try{
    sendToIAButton.disabled = true;
    sendToIAButton.textContent = 'Enviando para IA...';

    const res = await fetch(LOVART_ENDPOINT, {
      method:'POST',
      headers:{
        // possivelmente você precisará de autorização no header
        'Authorization': `Bearer ${API_KEY}`
        // não defina Content-Type — fetch com FormData cuida disso
      },
      body: fd
    });

    if(!res.ok){
      throw new Error('Resposta do servidor: ' + res.status + ' - ' + (await res.text()));
    }

    // supondo que a API retorna JSON com base64
    const data = await res.json();
    // ajuste conforme retorno real:
    // Exemplo esperado: { "result_base64": "data:image/png;base64,..." } ou { "result_url": "https://..." }
    if(data.result_base64){
      iaResult.src = data.result_base64;
      iaResult.style.display = 'block';
      iaResult.alt = 'Resultado Lovart';
      iaResult.scrollIntoView({behavior:'smooth', block:'center'});
    } else if(data.result_url){
      iaResult.src = data.result_url;
      iaResult.style.display = 'block';
      iaResult.scrollIntoView({behavior:'smooth', block:'center'});
    } else {
      // resposta inesperada
      alert('Retorno inesperado da API. Veja o console para detalhes.');
      console.log('Resposta Lovart:', data);
    }

  } catch(err){
    console.error(err);
    alert('Erro ao enviar para IA: ' + err.message);
  } finally {
    sendToIAButton.disabled = false;
    sendToIAButton.textContent = 'Testar com IA (Lovart)';
  }
}

sendToIAButton.addEventListener('click', ()=>{
  // chama a função de envio
  sendToLovart();
});
</script>
</body>
</html>
