<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciar Professores - AprovaMaisPB</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Seu CSS atual permanece igual */
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <a href="dashboard.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
        </a>
        <h1>Gerenciar Professores</h1>
        <div></div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="openTab('professores')">Lista de Professores</button>
        <button class="tab" onclick="openTab('designar')">Designar Turmas</button>
    </div>

    <div id="professores" class="tab-content active">
        <div class="table-container">
            <table id="teachersTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Matéria</th>
                        <th>Usuário</th>
                        <th>Status</th>
                        <th>Turmas</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados do Firebase serão inseridos aqui -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="designar" class="tab-content">
        <h2>Designar Turma para Professor</h2>
        <div class="form-group">
            <label for="selectProfessor">Selecionar Professor</label>
            <select id="selectProfessor">
                <option value="">Selecione um professor</option>
            </select>
        </div>
        <div class="form-group">
            <label for="selectTurma">Selecionar Turma</label>
            <select id="selectTurma">
                <option value="">Selecione uma turma</option>
                <option value="Turma A - Manhã">Turma A - Manhã</option>
                <option value="Turma B - Tarde">Turma B - Tarde</option>
                <option value="Turma C - Noite">Turma C - Noite</option>
            </select>
        </div>
        <div class="form-actions">
            <button class="btn" onclick="designarTurma()"><i class="fas fa-link"></i> Designar Turma</button>
        </div>

        <div id="designacoesList" style="margin-top:30px;">
            <h3>Designações Ativas</h3>
            <table>
                <thead>
                    <tr>
                        <th>Professor</th>
                        <th>Turma</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="designacoesBody">
                    <!-- Designações Firebase -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para editar professor -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h2>Editar Professor</h2>
        <div class="form-group">
            <label for="editName">Nome Completo</label>
            <input type="text" id="editName">
        </div>
        <div class="form-group">
            <label for="editEmail">E-mail</label>
            <input type="email" id="editEmail">
        </div>
        <div class="form-group">
            <label for="editMateria">Matéria</label>
            <select id="editMateria">
                <option value="portugues">Português</option>
                <option value="matematica">Matemática</option>
                <option value="historia">História</option>
                <option value="geografia">Geografia</option>
                <option value="ingles">Inglês</option>
            </select>
        </div>
        <div class="form-group">
            <label for="editStatus">Status</label>
            <select id="editStatus">
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
            </select>
        </div>
        <div class="form-actions">
            <button class="btn" onclick="closeModal('editModal')">Cancelar</button>
            <button class="btn" style="background: var(--primary);" onclick="salvarEdicao()">Salvar</button>
        </div>
    </div>
</div>

<script type="module">
    import { db, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from './assets/js/firebase-config.js';

    let professores = [];
    let designacoes = [];
    let professorEditando = null;

    // Função de abas
    function openTab(tabName) {
        const tabContents = document.getElementsByClassName('tab-content');
        for (let t of tabContents) t.classList.remove('active');

        const tabs = document.getElementsByClassName('tab');
        for (let b of tabs) b.classList.remove('active');

        document.getElementById(tabName).classList.add('active');
        event.currentTarget.classList.add('active');

        if(tabName==='designar') carregarProfessoresParaDesignacao();
    }

    async function carregarProfessores() {
        const tbody = document.querySelector('#teachersTable tbody');
        tbody.innerHTML = '';

        const querySnapshot = await getDocs(collection(db, 'professores'));
        professores = [];
        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            data.id = docSnap.id;
            professores.push(data);
        });

        for (let professor of professores) {
            const turmas = designacoes.filter(d => d.professorId===professor.id).map(d=>d.turma).join(', ') || 'Nenhuma';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${professor.nome}</td>
                <td>${professor.materia}</td>
                <td>${professor.usuario}</td>
                <td><span class="status ${professor.status}">${professor.status}</span></td>
                <td>${turmas}</td>
                <td>
                    <button class="btn" onclick="editarProfessor('${professor.id}')"><i class="fas fa-edit"></i> Editar</button>
                    <button class="btn delete-btn" onclick="excluirProfessor('${professor.id}')"><i class="fas fa-trash"></i> Excluir</button>
                </td>
            `;
            tbody.appendChild(row);
        }
    }

    async function editarProfessor(id) {
        const professor = professores.find(p => p.id===id);
        if(!professor) return;
        professorEditando = professor;
        document.getElementById('editName').value = professor.nome;
        document.getElementById('editEmail').value = professor.email;
        document.getElementById('editMateria').value = professor.materia;
        document.getElementById('editStatus').value = professor.status;
        document.getElementById('editModal').style.display = 'flex';
    }

    async function salvarEdicao() {
        if(!professorEditando) return;
        const ref = doc(db, 'professores', professorEditando.id);
        await updateDoc(ref, {
            nome: document.getElementById('editName').value,
            email: document.getElementById('editEmail').value,
            materia: document.getElementById('editMateria').value,
            status: document.getElementById('editStatus').value
        });
        closeModal('editModal');
        carregarProfessores();
        alert('Professor atualizado com sucesso!');
    }

    async function excluirProfessor(id) {
        if(!confirm('Deseja realmente excluir este professor?')) return;
        // Verificar designações aqui se necessário
        const ref = doc(db, 'professores', id);
        await deleteDoc(ref);
        carregarProfessores();
        alert('Professor excluído com sucesso!');
    }

    function closeModal(id) {
        document.getElementById(id).style.display='none';
    }

    async function carregarProfessoresParaDesignacao() {
        const select = document.getElementById('selectProfessor');
        select.innerHTML = '<option value="">Selecione um professor</option>';
        for(let p of professores.filter(p=>p.status==='ativo')){
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.nome} - ${p.materia}`;
            select.appendChild(option);
        }
    }

    async function designarTurma() {
        const professorId = document.getElementById('selectProfessor').value;
        const turma = document.getElementById('selectTurma').value;
        if(!professorId || !turma){ alert('Selecione professor e turma'); return; }

        // Adicionar designação no Firebase
        await addDoc(collection(db,'designacoes'), {
            professorId,
            turma,
            dataDesignacao: new Date().toISOString()
        });
        alert('Turma designada com sucesso!');
        carregarDesignacoes();
    }

    async function carregarDesignacoes() {
        const tbody = document.getElementById('designacoesBody');
        tbody.innerHTML = '';
        const querySnap = await getDocs(collection(db,'designacoes'));
        designacoes=[];
        querySnap.forEach(docSnap=>{
            const data = docSnap.data();
            data.id = docSnap.id;
            designacoes.push(data);
        });

        for(let d of designacoes){
            const prof = professores.find(p=>p.id===d.professorId);
            if(!prof) continue;
            const row = document.createElement('tr');
            row.innerHTML=`
                <td>${prof.nome}</td>
                <td>${d.turma}</td>
                <td>
                    <button class="btn delete-btn" onclick="removerDesignacao('${d.id}')"><i class="fas fa-unlink"></i> Remover</button>
                </td>
            `;
            tbody.appendChild(row);
        }
    }

    async function removerDesignacao(id){
        if(!confirm('Remover designação?')) return;
        await deleteDoc(doc(db,'designacoes',id));
        carregarDesignacoes();
        carregarProfessores();
    }

    // Carregar dados ao iniciar
    window.addEventListener('DOMContentLoaded', async ()=>{
        await carregarProfessores();
        await carregarDesignacoes();
    });

</script>
</body>
</html>
