<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - AprovaMaisPB</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root { --primary: #1a2a6c; --secondary: #b21f1f; --accent: #fdbb2d; }
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; }
body {
    background: linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);
    min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px;
}
.container {
    width:100%; max-width:600px; background:rgba(255,255,255,0.95); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.3); overflow:hidden; padding:30px;
}
.header { text-align:center; margin-bottom:20px; }
.header img { max-width:120px; margin-bottom:15px; }
.header h1 { font-size:24px; color:var(--primary); margin-bottom:5px; }
.header p { color:#555; }
.btn {
    padding:14px 25px; background:var(--primary); color:white; border:none; border-radius:6px;
    cursor:pointer; font-size:16px; font-weight:600; width:100%; transition:background 0.3s; text-align:center;
    margin-top:10px;
}
.btn:hover { background:#2a3a9c; }
.alert { padding:15px; border-radius:6px; margin-bottom:20px; display:none; }
.alert.success { background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; }
.alert.error { background:#ffebee; color:#d32f2f; border:1px solid #ffcdd2; }
.loading {
    display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3);
    border-radius:50%; border-top-color:#fff; animation:spin 1s linear infinite; margin-right:10px;
}
@keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="assets/img/logo_aprovamaispb.png" alt="Logo AprovaMaisPB">
        <h1>Checkout - AprovaMaisPB</h1>
        <p>Valor fixo: R$150,00</p>
    </div>

    <div class="alert success" id="successAlert"><i class="fas fa-check-circle"></i> Pagamento aprovado!</div>
    <div class="alert error" id="errorAlert"><i class="fas fa-exclamation-circle"></i> Ocorreu um erro no pagamento.</div>

    <button id="payBtn" class="btn">
        <span id="btnText">Pagar R$150,00</span>
        <span id="btnLoading" class="loading" style="display:none;"></span>
    </button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- PagSeguro Transparente -->
<script src="https://stc.pagseguro.uol.com.br/pagseguro/api/v2/checkout/pagseguro.directpayment.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAK3U35fipoWOOIJg0yrtgmVfQ7XQxZxqY",
    authDomain: "aprovamaispb-d4e75.firebaseapp.com",
    projectId: "aprovamaispb-d4e75",
    storageBucket: "aprovamaispb-d4e75.firebasestorage.app",
    messagingSenderId: "828577018900",
    appId: "1:828577018900:web:473d8c3fc2685d3f192301"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Recebe matrículaId e valor da URL
const urlParams = new URLSearchParams(window.location.search);
const matriculaId = urlParams.get('matriculaId');
const valor = parseFloat(urlParams.get('valor') || 150);

const payBtn = document.getElementById('payBtn');
const btnText = document.getElementById('btnText');
const btnLoading = document.getElementById('btnLoading');
const successAlert = document.getElementById('successAlert');
const errorAlert = document.getElementById('errorAlert');

// Token PagSeguro
const PAGSEGURO_TOKEN = "f3f24edd-dabd-4975-994b-77f6b75f3ab6a55011fb48-d06e-4ffa-8b30-87a340f7d72c";

payBtn.addEventListener('click', async () => {
    btnText.style.display='none';
    btnLoading.style.display='inline-block';
    payBtn.disabled = true;

    try {
        // 1️⃣ Criar sessão PagSeguro
        const response = await fetch(`https://ws.pagseguro.uol.com.br/v2/sessions`, {
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body:`email=SEU_EMAIL_PAGSEGURO&token=${PAGSEGURO_TOKEN}`
        });
        const text = await response.text();
        const sessionId = text.match(/<id>(.*?)<\/id>/)[1];
        PagSeguroDirectPayment.setSessionId(sessionId);

        // 2️⃣ Aqui você integraria cartão ou PIX usando PagSeguro
        // Para teste, simulamos aprovação após 2s
        await new Promise(res => setTimeout(res, 2000));

        // 3️⃣ Atualiza Firestore
        await db.collection("inscricoes").doc(matriculaId).update({
            valorPago: valor,
            status: "ativo"
        });

        successAlert.style.display='block';
        errorAlert.style.display='none';
        btnLoading.style.display='none';

    } catch(err) {
        console.error(err);
        errorAlert.style.display='block';
        successAlert.style.display='none';
        btnText.style.display='block';
        btnLoading.style.display='none';
        payBtn.disabled = false;
    }
});
</script>
</body>
</html>
