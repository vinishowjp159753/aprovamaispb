<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - AprovaMaisPB</title>
<link rel="stylesheet" href="assets/css/checkout.css">
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .container {
        width: 100%;
        max-width: 500px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 30px;
        text-align: center;
    }
    h1 { color: #1a2a6c; margin-bottom: 20px; }
    #status { margin-top: 20px; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
    <h1>Finalizar Pagamento</h1>
    <p>Mensalidade: R$150,00</p>

    <!-- Botão PayPal -->
    <div id="paypal-button-container"></div>

    <div id="status"></div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Config Firebase (mesma do seu site)
const firebaseConfig = {
  apiKey: "AIzaSyAK3U35fipoWOOIJg0yrtgmVfQ7XQxZxqY",
  authDomain: "aprovamaispb-d4e75.firebaseapp.com",
  projectId: "aprovamaispb-d4e75",
  storageBucket: "aprovamaispb-d4e75.firebasestorage.app",
  messagingSenderId: "828577018900",
  appId: "1:828577018900:web:473d8c3fc2685d3f192301"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Captura ID da matrícula via URL
const urlParams = new URLSearchParams(window.location.search);
const matriculaId = urlParams.get('matriculaId');

</script>

<!-- SDK do PayPal -->
<script src="https://www.paypal.com/sdk/js?client-id=AUF39hiK8lh_k7R4yY6jvg9LiMrIkjRXcry5_2iOWNAHKTgiiGK7haFrbTYN1blF2XtJNaRewiP6kcg9&currency=BRL"></script>

<script type="module">
import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const statusDiv = document.getElementById('status');

paypal.Buttons({
    createOrder: function(data, actions) {
        return actions.order.create({
            purchase_units: [{
                amount: { value: '150.00' },
                description: 'Mensalidade AprovaMaisPB'
            }]
        });
    },
    onApprove: async function(data, actions) {
        const order = await actions.order.capture();
        console.log(order);
        statusDiv.textContent = 'Pagamento aprovado! Atualizando matrícula...';

        try {
            // Atualiza campo valorPago no Firebase
            const alunoRef = doc(db, "inscricoes", matriculaId);
            await updateDoc(alunoRef, { valorPago: 150, status: 'ativo' });
            statusDiv.textContent = 'Pagamento confirmado! Matrícula ativa.';
        } catch (err) {
            console.error('Erro ao atualizar matrícula:', err);
            statusDiv.textContent = 'Pagamento aprovado, mas houve erro ao atualizar matrícula.';
        }
    },
    onCancel: function(data) {
        statusDiv.textContent = 'Pagamento cancelado.';
    },
    onError: function(err) {
        console.error(err);
        statusDiv.textContent = 'Erro no pagamento. Tente novamente.';
    }
}).render('#paypal-button-container');
</script>

</body>
</html>
