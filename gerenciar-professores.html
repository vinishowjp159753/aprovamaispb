<script type="module">
    import { initializeApp } from './assets/js/firebase-config.js';
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, query, where } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp();
    const db = getFirestore(app);
    let professores = [];
    let professorEditando = null;

    async function carregarProfessores() {
        const snapshot = await getDocs(collection(db, "professores"));
        professores = [];
        snapshot.forEach(docSnap => professores.push({ id: docSnap.id, ...docSnap.data() }));
        preencherTabela();
        carregarProfessoresSelect();
    }

    function preencherTabela() {
        const tbody = document.querySelector("#teachersTable tbody");
        tbody.innerHTML = "";
        professores.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.nome}</td>
                <td>${p.materia}</td>
                <td>${p.usuario}</td>
                <td><span class="status ${p.status}">${p.status}</span></td>
                <td>
                    <button class="btn" onclick="editarProfessor('${p.id}')"><i class="fas fa-edit"></i> Editar</button>
                    <button class="btn delete-btn" onclick="excluirProfessor('${p.id}')"><i class="fas fa-trash"></i> Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function openTab(tabName, e) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        e.currentTarget.classList.add('active');
        if(tabName === 'designar') carregarDesignacoes();
    }

    async function editarProfessor(id) {
        const p = professores.find(x => x.id === id);
        professorEditando = p;
        document.getElementById("editName").value = p.nome;
        document.getElementById("editEmail").value = p.email;
        document.getElementById("editMateria").value = p.materia;
        document.getElementById("editStatus").value = p.status;
        document.getElementById("editModal").style.display = "flex";
    }

    async function salvarEdicao() {
        if(!professorEditando) return;
        await updateDoc(doc(db, "professores", professorEditando.id), {
            nome: document.getElementById("editName").value,
            email: document.getElementById("editEmail").value,
            materia: document.getElementById("editMateria").value,
            status: document.getElementById("editStatus").value
        });
        closeModal();
        carregarProfessores();
        alert("Professor atualizado com sucesso!");
    }

    async function excluirProfessor(id) {
        if(!confirm("Deseja realmente excluir este professor?")) return;
        const q = query(collection(db,"designacoes"), where("professorId","==",id));
        const snapshot = await getDocs(q);
        if(!snapshot.empty){ 
            alert("Remova as designações deste professor antes de excluir."); 
            return; 
        }
        await deleteDoc(doc(db,"professores",id));
        carregarProfessores();
        alert("Professor excluído com sucesso!");
    }

    function closeModal(){ document.getElementById("editModal").style.display="none"; }

    function carregarProfessoresSelect(){
        const select = document.getElementById("selectProfessor");
        select.innerHTML = `<option value="">Selecione um professor</option>`;
        professores.filter(p=>p.status==="ativo").forEach(p=>{
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${p.nome} - ${p.materia}`;
            select.appendChild(opt);
        });
    }

    async function designarTurma(){
        const profId = document.getElementById("selectProfessor").value;
        const turma = document.getElementById("selectTurma").value;
        if(!profId || !turma){ alert("Selecione professor e turma"); return; }
        const q = query(collection(db,"designacoes"), where("professorId","==",profId), where("turma","==",turma));
        const snapshot = await getDocs(q);
        if(!snapshot.empty){ alert("Esta designação já existe"); return; }
        await addDoc(collection(db,"designacoes"), { professorId: profId, turma });
        carregarDesignacoes();
        alert("Turma designada com sucesso!");
    }

    async function carregarDesignacoes(){
        const snapshot = await getDocs(collection(db,"designacoes"));
        const tbody = document.getElementById("designacoesBody");
        tbody.innerHTML = "";
        snapshot.forEach(d => {
            const prof = professores.find(p=>p.id===d.data().professorId);
            if(prof){
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${prof.nome}</td><td>${d.data().turma}</td>
                    <td><button class="btn delete-btn" onclick="removerDesignacao('${d.id}')"><i class="fas fa-unlink"></i> Remover</button></td>`;
                tbody.appendChild(tr);
            }
        });
    }

    async function removerDesignacao(id){ 
        await deleteDoc(doc(db,"designacoes",id)); 
        carregarDesignacoes(); 
    }

    // Expor no escopo global para os botões funcionarem
    window.editarProfessor = editarProfessor;
    window.excluirProfessor = excluirProfessor;
    window.salvarEdicao = salvarEdicao;
    window.closeModal = closeModal;
    window.openTab = openTab;
    window.designarTurma = designarTurma;
    window.removerDesignacao = removerDesignacao;

    // Inicialização
    window.addEventListener("DOMContentLoaded", carregarProfessores);
    window.onclick = e=>{ if(e.target.classList.contains("modal")) closeModal(); }
</script>
