<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciar Professores - AprovaMaisPB</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root { --primary: #1a2a6c; --secondary: #b21f1f; --accent: #fdbb2d; }
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background-color:#f5f7fb; color:#333; }
.container { max-width:1200px; margin:0 auto; padding:20px; }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; }
.back-btn { display:inline-flex; align-items:center; padding:10px 15px; background:var(--primary); color:white; text-decoration:none; border-radius:5px; font-weight:500; }
.back-btn i { margin-right:8px; }
h1 { color:var(--primary); text-align:center; margin:20px 0; }
.tabs { display:flex; margin-bottom:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.tab { padding:15px 25px; cursor:pointer; background:#f8f9fa; border:none; flex:1; font-weight:500; }
.tab.active { background:var(--primary); color:white; }
.tab-content { display:none; background:white; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.05); }
.tab-content.active { display:block; }
.table-container { overflow-x:auto; }
table { width:100%; border-collapse:collapse; }
th, td { padding:12px; text-align:left; border-bottom:1px solid #eee; }
th { background:var(--primary); color:white; font-weight:500; }
tr:hover { background:#f9f9f9; }
.btn { padding:6px 12px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer; font-weight:500; }
.btn i { margin-right:5px; }
.assign-btn { background:var(--accent); color:#000; }
.delete-btn { background:var(--secondary); color:white; }
.status { padding:5px 10px; border-radius:20px; font-size:12px; font-weight:500; }
.status.ativo { background:#e8f5e9; color:#2e7d32; }
.status.inativo { background:#ffebee; color:#d32f2f; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:white; padding:30px; border-radius:10px; width:500px; max-width:90%; }
.form-group { margin-bottom:15px; }
select,input { width:100%; padding:10px; border-radius:5px; border:1px solid #ddd; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <a href="dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Voltar ao Dashboard</a>
        <h1>Gerenciar Professores</h1>
        <div></div>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="professores">Lista de Professores</button>
        <button class="tab" data-tab="designar">Designar Turmas</button>
    </div>

    <!-- Aba Lista de Professores -->
    <div id="professores" class="tab-content active">
        <div class="table-container">
            <table id="teachersTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Matéria</th>
                        <th>Usuário</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Aba Designar Turmas -->
    <div id="designar" class="tab-content">
        <div class="form-group">
            <label for="selectProfessor">Selecionar Professor</label>
            <select id="selectProfessor">
                <option value="">Selecione um professor</option>
            </select>
        </div>
        <div class="form-group">
            <label for="selectTurma">Selecionar Turma</label>
            <select id="selectTurma">
                <option value="">Selecione uma turma</option>
                <option value="Turma A - Manhã">Turma A - Manhã</option>
                <option value="Turma B - Tarde">Turma B - Tarde</option>
                <option value="Turma C - Noite">Turma C - Noite</option>
            </select>
        </div>
        <button class="btn assign-btn" id="designarTurmaBtn">Designar Turma</button>

        <h3 style="margin-top:20px;">Designações Ativas</h3>

        <!-- Filtros e Busca -->
        <div class="table-container">
            <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                <input type="text" id="searchDesignacoes" placeholder="Buscar por professor ou aluno..." style="flex:1; padding:8px; border-radius:5px; border:1px solid #ccc;">
                <select id="filterTurma">
                    <option value="">Todas as turmas</option>
                    <option value="Turma A - Manhã">Turma A - Manhã</option>
                    <option value="Turma B - Tarde">Turma B - Tarde</option>
                    <option value="Turma C - Noite">Turma C - Noite</option>
                </select>
                <select id="filterStatus">
                    <option value="">Todos os status</option>
                    <option value="ativo">Ativo</option>
                    <option value="inativo">Inativo</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr><th>Professor</th><th>Turma</th><th>Aluno</th><th>Ação</th></tr>
                </thead>
                <tbody id="designacoesBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Editar Professor -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h2>Editar Professor</h2>
        <div class="form-group">
            <label for="editName">Nome Completo</label>
            <input type="text" id="editName">
        </div>
        <div class="form-group">
            <label for="editEmail">E-mail</label>
            <input type="email" id="editEmail">
        </div>
        <div class="form-group">
            <label for="editMateria">Matéria</label>
            <select id="editMateria">
                <option value="portugues">Português</option>
                <option value="matematica">Matemática</option>
                <option value="historia">História</option>
                <option value="geografia">Geografia</option>
                <option value="ingles">Inglês</option>
            </select>
        </div>
        <div class="form-group">
            <label for="editStatus">Status</label>
            <select id="editStatus">
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
            </select>
        </div>
        <div class="form-actions">
            <button class="btn" id="cancelarEdicaoBtn">Cancelar</button>
            <button class="btn" style="background: var(--primary);" id="salvarEdicaoBtn">Salvar</button>
        </div>
    </div>
</div>

<script type="module">
import { app, db } from "./assets/js/firebase-config.js";
import { collection, getDocs, doc, updateDoc, deleteDoc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

let professores = [];
let alunos = [];
let professorEditando = null;

// Carregar professores
async function carregarProfessores() {
    const snap = await getDocs(collection(db, "professores"));
    professores = [];
    snap.forEach(d => professores.push({ id: d.id, ...d.data() }));
    preencherTabela();
    carregarProfessoresSelect();
}

// Preencher tabela de professores
function preencherTabela() {
    const tbody = document.querySelector("#teachersTable tbody");
    tbody.innerHTML = "";
    professores.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${p.nome}</td>
            <td>${p.materia}</td>
            <td>${p.usuario || ''}</td>
            <td><span class="status ${p.status}">${p.status}</span></td>
            <td>
                <button class="btn editar-prof-btn" data-id="${p.id}"><i class="fas fa-edit"></i>Editar</button>
                <button class="btn delete-btn excluir-prof-btn" data-id="${p.id}"><i class="fas fa-trash"></i>Excluir</button>
            </td>`;
        tbody.appendChild(tr);
    });

    document.querySelectorAll('.editar-prof-btn').forEach(btn=>btn.addEventListener('click',()=>editarProfessor(btn.dataset.id)));
    document.querySelectorAll('.excluir-prof-btn').forEach(btn=>btn.addEventListener('click',()=>excluirProfessor(btn.dataset.id)));
}

// Modal de edição
function editarProfessor(id){
    const p = professores.find(x=>x.id===id);
    if(!p) return;
    professorEditando = p;
    document.getElementById("editName").value = p.nome;
    document.getElementById("editEmail").value = p.email || '';
    document.getElementById("editMateria").value = p.materia;
    document.getElementById("editStatus").value = p.status;
    document.getElementById("editModal").style.display = "flex";
}

async function salvarEdicao() {
    if(!professorEditando) return;
    await updateDoc(doc(db,"professores",professorEditando.id),{
        nome: document.getElementById("editName").value,
        email: document.getElementById("editEmail").value,
        materia: document.getElementById("editMateria").value,
        status: document.getElementById("editStatus").value
    });
    closeModal();
    carregarProfessores();
    alert("Professor atualizado!");
}

function closeModal(){ document.getElementById("editModal").style.display="none"; }

// Excluir professor
async function excluirProfessor(id){
    if(!confirm("Deseja realmente excluir este professor?")) return;
    const q = query(collection(db,"designacoes"), where("professorId","==",id));
    const snap = await getDocs(q);
    if(!snap.empty){ alert("Remova as designações antes de excluir."); return; }
    await deleteDoc(doc(db,"professores",id));
    carregarProfessores();
}

// Carregar select de professores ativos
function carregarProfessoresSelect(){
    const select = document.getElementById("selectProfessor");
    select.innerHTML = `<option value="">Selecione um professor</option>`;
    professores.filter(p=>p.status==="ativo").forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.nome} - ${p.materia}`;
        select.appendChild(opt);
    });
}

// Designar turma
async function designarTurma(){
    const profId = document.getElementById("selectProfessor").value;
    const turma = document.getElementById("selectTurma").value;
    if(!profId || !turma){ alert("Selecione professor e turma"); return; }
    const q = query(collection(db,"designacoes"), where("professorId","==",profId), where("turma","==",turma));
    const snap = await getDocs(q);
    if(!snap.empty){ alert("Designação já existe"); return; }
    await addDoc(collection(db,"designacoes"), { professorId: profId, turma });
    document.getElementById("selectProfessor").value="";
    document.getElementById("selectTurma").value="";
    carregarDesignacoes();
    alert("Turma designada!");
}

// Carregar designações
async function carregarDesignacoes(){
    const snap = await getDocs(collection(db,"designacoes"));
    const tbody = document.getElementById("designacoesBody");
    tbody.innerHTML = "";

    const busca = document.getElementById("searchDesignacoes").value.toLowerCase();
    const turmaFiltro = document.getElementById("filterTurma").value.toLowerCase();
    const statusFiltro = document.getElementById("filterStatus").value.toLowerCase();

    snap.forEach(d=>{
        const data = d.data();
        const prof = professores.find(p=>p.id===data.professorId);
        if(!prof) return;
        if(turmaFiltro && data.turma.toLowerCase()!==turmaFiltro) return;
        if(statusFiltro && prof.status.toLowerCase()!==statusFiltro) return;
        if(busca && !prof.nome.toLowerCase().includes(busca)) return;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${prof.nome}</td>
            <td>${data.turma}</td>
            <td>-</td>
            <td><button class="btn delete-btn" onclick="removerDesignacao('${d.id}')"><i class="fas fa-unlink"></i>Remover</button></td>`;
        tbody.appendChild(tr);
    });
}

// Remover designação
async function removerDesignacao(id){
    await deleteDoc(doc(db,"designacoes",id));
    carregarDesignacoes();
}

// Inicialização
document.addEventListener("DOMContentLoaded", function(){
    carregarProfessores();

    document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click', (e)=>{
            const tabName = tab.dataset.tab;
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            if(tabName==="designar") carregarDesignacoes();
        });
    });

    document.getElementById("designarTurmaBtn").addEventListener("click", designarTurma);
    document.getElementById("salvarEdicaoBtn").addEventListener("click", salvarEdicao);
    document.getElementById("cancelarEdicaoBtn").addEventListener("click", closeModal);
    window.onclick = e=>{ if(e.target.classList.contains("modal")) closeModal(); }

    document.getElementById("searchDesignacoes").addEventListener("input", carregarDesignacoes);
    document.getElementById("filterTurma").addEventListener("change", carregarDesignacoes);
    document.getElementById("filterStatus").addEventListener("change", carregarDesignacoes);
});
</script>
</body>
</html>
