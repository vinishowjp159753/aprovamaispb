<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="assets/img/logo_aprovamaispb.png" />
<title>Lista de Alunos</title>

<style>
body {
    font-family: "Segoe UI", Roboto, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: #fff;
}
.container { max-width: 1200px; margin: 30px auto; padding: 20px; }
#contadorAlunos { font-size: 16px; margin-bottom: 10px; }
.table-btn {
    background: linear-gradient(90deg,#1a2a6c,#3b5fc7);
    color: #fff;
    border: none;
    padding: 8px 16px;
    margin: 4px 4px 4px 0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}
.table-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
.table-btn.delete { background: #ff4d4d; }
.table-btn.delete:hover { background: #ff1a1a; }
#searchInput {
    width: 100%; padding: 10px 12px; margin: 15px 0; border-radius: 6px;
    border: 1px solid #ccc; font-size: 14px; outline: none;
    transition: box-shadow 0.2s, border-color 0.2s;
}
#searchInput:focus { border-color: #1a2a6c; box-shadow: 0 0 8px rgba(26,42,108,0.7); }
table {
    width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.05);
    border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 14px;
}
thead th {
    background: linear-gradient(90deg,#1a2a6c,#3b5fc7);
    color: #fff; padding: 12px; text-align: left; cursor: pointer;
}
thead th.sort-asc::after { content: " ↑"; }
thead th.sort-desc::after { content: " ↓"; }
tbody td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); vertical-align: top; }
tbody tr:nth-child(even) { background: rgba(255,255,255,0.05); }
tbody tr:hover { background: rgba(59,95,199,0.2); }
.status-ativo { color: #00ff99; font-weight: bold; }
.status-pendente { color: #ffcc00; font-weight: bold; }
#loader {
    display: none;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); color: #fff; font-size: 20px;
    display: flex; align-items: center; justify-content: center; z-index: 9999;
}
</style>
</head>
<body>

<div id="loader">Aguarde...</div>

<div class="container">
    <button id="backBtn" class="table-btn">← Voltar ao Dashboard</button>
    <button id="downloadBtn" class="table-btn">⬇️ Baixar Lista</button>
    <button id="ativarTodosBtn" class="table-btn">✅ Ativar Todos</button>
    <button id="desativarTodosBtn" class="table-btn delete">❌ Desativar Todos</button>

    <div id="contadorAlunos">Alunos: 0</div>
    <input type="text" id="searchInput" placeholder="Buscar aluno...">

    <table>
        <thead>
            <tr>
                <th id="dateHeader">Data</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>N° de Inscrição</th>
                <th>Telefone</th>
                <th>Status</th>
                <th>Aluno Ethos</th>
                <th>Ações</th>
                <th>WhatsApp</th>
                <th>QR Code</th>
            </tr>
        </thead>
        <tbody id="alunosTableBody"></tbody>
    </table>
</div>

<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { db } from "./assets/js/firebase-config.js";
import { collection, getDocs, doc, writeBatch, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const alunosTableBody = document.getElementById("alunosTableBody");
const searchInput      = document.getElementById("searchInput");
const downloadBtn      = document.getElementById("downloadBtn");
const dateHeader       = document.getElementById("dateHeader");
const contadorEl       = document.getElementById("contadorAlunos");
const ativarTodosBtn   = document.getElementById("ativarTodosBtn");
const desativarTodosBtn= document.getElementById("desativarTodosBtn");
const backBtn          = document.getElementById("backBtn");
const loader           = document.getElementById("loader");

let alunosData = [];
let ascendingOrder = true;

// Voltar para dashboard
backBtn.addEventListener("click", () => { window.location.href = "dashboard.html"; });

// Loader
function showLoader(){ loader.style.display="flex"; }
function hideLoader(){ loader.style.display="none"; }

// Carregar alunos
async function loadAlunos() {
    const snapshot = await getDocs(collection(db, "inscricoes"));
    alunosData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    alunosData.sort((a,b)=>{
        if(!a.Data) return 1;
        if(!b.Data) return -1;
        return ascendingOrder ? new Date(a.Data) - new Date(b.Data) : new Date(b.Data) - new Date(a.Data);
    });
    renderTable(alunosData);
}

// Formatar data
function formatDate(dataStr) {
    if(!dataStr) return "";
    const d = new Date(dataStr);
    return d.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
}

// Renderizar tabela
function renderTable(data){
    const term = searchInput.value.toLowerCase();
    const filtered = data.filter(a =>
        (a.Nome||"").toLowerCase().includes(term) ||
        (a.CPF||"").toLowerCase().includes(term) ||
        (a.Cupom||"").toLowerCase().includes(term) ||
        ((a["Aluno Ethos"]||"").toLowerCase().includes(term))
    );

    alunosTableBody.innerHTML = "";
    filtered.forEach(aluno => {
        const statusClass = aluno.status==="ativo" ? "status-ativo" : "status-pendente";
        const mensagem = `Olá ${aluno.Nome},\n\nSua inscrição está CONFIRMADA!\nNúmero de inscrição: ${aluno.Cupom}\nCPF: ${aluno.CPF}`;
        const phone = (aluno.Telefone||"").replace(/\D/g,"");
        const linkWhats = `https://api.whatsapp.com/send?phone=55${phone}&text=${encodeURIComponent(mensagem)}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${formatDate(aluno.Data)}</td>
            <td>${aluno.Nome||""}</td>
            <td>${aluno.CPF||""}</td>
            <td>${aluno.Cupom||""}</td>
            <td>${aluno.Telefone||""}</td>
            <td class="${statusClass}">${aluno.status||""}</td>
            <td>${aluno["Aluno Ethos"]||""}</td>
            <td>
                <button class="table-btn" onclick="toggleStatus('${aluno.id}')">Status</button>
                <button class="table-btn delete" onclick="deleteAluno('${aluno.id}')">Excluir</button>
                <button class="table-btn">Pagamento</button>
                <button class="table-btn">Observação</button>
            </td>
            <td><a class="table-btn" target="_blank" href="${linkWhats}">WhatsApp</a></td>
            <td>
                <button class="table-btn" onclick="baixarQR('${aluno.Cupom}')">⬇️ Baixar QR</button>
                <canvas id="qr_${aluno.Cupom}" style="display:none;"></canvas>
            </td>
        `;
        alunosTableBody.appendChild(tr);
    });
    contadorEl.textContent = `Alunos: ${filtered.length}`;
}

// Alterar status individual
window.toggleStatus = async function(id){
    const aluno = alunosData.find(a=>a.id===id);
    if(!aluno) return;
    showLoader();
    const novoStatus = aluno.status==="pendente" ? "ativo" : "pendente";
    await updateDoc(doc(db,"inscricoes",id),{ status: novoStatus });
    await loadAlunos();
    hideLoader();
}

// Excluir aluno
window.deleteAluno = async function(id){
    const aluno = alunosData.find(a=>a.id===id);
    if(!aluno) return;
    if(confirm(`Deseja excluir ${aluno.Nome}?`)){
        showLoader();
        await deleteDoc(doc(db,"inscricoes",id));
        await loadAlunos();
        hideLoader();
    }
}

// Ativar/Desativar todos com batch
async function atualizarTodos(status){
    if(!confirm(`Tem certeza que deseja ${status==="ativo"?"ATIVAR":"DESATIVAR"} todos os alunos?`)) return;
    showLoader();
    const batch = writeBatch(db);
    alunosData.forEach(a=> batch.update(doc(db,"inscricoes",a.id), { status }) );
    await batch.commit();
    await loadAlunos();
    hideLoader();
    alert(`Todos os alunos foram ${status==="ativo"?"ATIVADOS":"DESATIVADOS"}.`);
}
ativarTodosBtn.addEventListener("click", ()=> atualizarTodos("ativo"));
desativarTodosBtn.addEventListener("click", ()=> atualizarTodos("pendente"));

// Gerar QR sob demanda
window.baixarQR = function(cupom){
    const canvas = document.getElementById(`qr_${cupom}`);
    const url = `validar.html?inscricao=${cupom}`;
    QRCode.toCanvas(canvas, url, { width: 150 }, function(err){
        if(err){ alert("Erro ao gerar QR"); return; }
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `inscricao_${cupom}.png`;
        link.click();
    });
}

// Busca
searchInput.addEventListener("input", ()=> renderTable(alunosData));

// Ordenar por data
dateHeader.addEventListener("click", ()=>{ ascendingOrder=!ascendingOrder; renderTable(alunosData); });

// Exportar Excel (somente alunos filtrados)
downloadBtn.addEventListener("click", ()=>{
    const filtered = alunosData.filter(a =>
        (a.Nome||"").toLowerCase().includes(searchInput.value.toLowerCase()) ||
        (a.CPF||"").toLowerCase().includes(searchInput.value.toLowerCase()) ||
        (a.Cupom||"").toLowerCase().includes(searchInput.value.toLowerCase())
    );
    const header = ["Data","Nome","CPF","N° de Inscrição","Telefone","Status","Aluno Ethos"];
    const rows = filtered.map(a=>[
        formatDate(a.Data), a.Nome||"", a.CPF||"", a.Cupom||"", a.Telefone||"", a.status||"", a["Aluno Ethos"]||""
    ]);
    const ws = XLSX.utils.aoa_to_sheet([header,...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws,"Alunos");
    XLSX.writeFile(wb,"lista_alunos.xlsx");
});

loadAlunos();
</script>
</body>
</html>
