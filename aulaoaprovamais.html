<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="assets/img/logo_aprovamaispb.png" />
<title>Lista de Alunos</title>

<style>
body {
    font-family: "Segoe UI", Roboto, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: #fff;
}
.container { max-width: 1200px; margin: 30px auto; padding: 20px; }
#contadorAlunos { font-size: 16px; margin-bottom: 10px; }
.table-btn {
    background: linear-gradient(90deg,#1a2a6c,#3b5fc7);
    color: #fff;
    border: none;
    padding: 8px 16px;
    margin: 4px 4px 4px 0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}
.table-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
.table-btn.delete { background: #ff4d4d; }
.table-btn.delete:hover { background: #ff1a1a; }
#searchInput {
    width: 100%; padding: 10px 12px; margin: 15px 0; border-radius: 6px;
    border: 1px solid #ccc; font-size: 14px; outline: none;
    transition: box-shadow 0.2s, border-color 0.2s;
}
#searchInput:focus { border-color: #1a2a6c; box-shadow: 0 0 8px rgba(26,42,108,0.7); }
table {
    width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.05);
    border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 14px;
    display: block; overflow-x: auto; /* responsivo */
}
thead th {
    background: linear-gradient(90deg,#1a2a6c,#3b5fc7);
    color: #fff; padding: 12px; text-align: left; cursor: pointer;
}
thead th.sort-asc::after { content: " ↑"; }
thead th.sort-desc::after { content: " ↓"; }
tbody td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); vertical-align: top; white-space: nowrap; }
tbody tr:nth-child(even) { background: rgba(255,255,255,0.05); }
tbody tr:hover { background: rgba(59,95,199,0.2); }
.status-ativo { color: #00ff99; font-weight: bold; }
.status-pendente { color: #ffcc00; font-weight: bold; }
#loader {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); color: #fff; font-size: 20px;
    display: flex; align-items: center; justify-content: center; z-index: 9999;
}
@media (max-width: 768px){
    .table-btn { padding: 6px 10px; font-size: 12px; }
    #searchInput { font-size: 12px; padding: 8px 10px; }
    #loader { font-size: 16px; padding: 10px; }
}
</style>
</head>
<body>

<div id="loader">Aguarde...</div>

<div class="container">
    <button id="backBtn" class="table-btn">← Voltar ao Dashboard</button>
    <button id="downloadBtn" class="table-btn">⬇️ Baixar Lista</button>
    <button id="ativarTodosBtn" class="table-btn">✅ Ativar Todos</button>
    <button id="desativarTodosBtn" class="table-btn delete">❌ Desativar Todos</button>

    <div id="contadorAlunos">Alunos: 0</div>
    <input type="text" id="searchInput" placeholder="Buscar aluno...">

    <table>
        <thead>
            <tr>
                <th id="dateHeader">Data</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>N° de Inscrição</th>
                <th>Telefone</th>
                <th>Status</th>
                <th>Aluno Ethos</th>
                <th>Ações</th>
                <th>WhatsApp</th>
                <th>QR Code</th>
            </tr>
        </thead>
        <tbody id="alunosTableBody"></tbody>
    </table>
</div>

<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { db } from "./assets/js/firebase-config.js";
import { collection, getDocs, doc, writeBatch, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const alunosTableBody = document.getElementById("alunosTableBody");
const searchInput      = document.getElementById("searchInput");
const downloadBtn      = document.getElementById("downloadBtn");
const dateHeader       = document.getElementById("dateHeader");
const contadorEl       = document.getElementById("contadorAlunos");
const ativarTodosBtn   = document.getElementById("ativarTodosBtn");
const desativarTodosBtn= document.getElementById("desativarTodosBtn");
const backBtn          = document.getElementById("backBtn");
const loader           = document.getElementById("loader");

let alunosData = [];
let ascendingOrder = true;

// Loader
function showLoader(){ loader.style.display="flex"; }
function hideLoader(){ loader.style.display="none"; }

// Voltar para dashboard
backBtn.addEventListener("click", () => { window.location.href = "dashboard.html"; });

// Função corrigida para aceitar formato brasileiro e ISO
function formatDate(dataStr) {
    if (!dataStr) return "";

    // Se for Timestamp do Firestore
    if (typeof dataStr === "object" && dataStr.seconds) {
        const d = new Date(dataStr.seconds * 1000);
        return d.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }

    // Se for string "dd/mm/yyyy hh:mm"
    const partes = dataStr.split(/[/ :]/);
    if (partes.length >= 3) {
        const [dia, mes, ano, hora = 0, minuto = 0] = partes.map(Number);
        const d = new Date(ano, mes - 1, dia, hora, minuto);
        if (!isNaN(d.getTime())) {
            return d.toLocaleString("pt-BR", {
                day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit"
            });
        }
    }

    // Se for formato ISO
    const d = new Date(dataStr);
    if (!isNaN(d.getTime())) {
        return d.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }

    return dataStr;
}

// Carregar alunos
async function loadAlunos() {
    showLoader();
    try {
        const snapshot = await getDocs(collection(db, "inscricoes"));
        alunosData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        alunosData.sort((a,b)=>{
            if(!a.Data) return 1;
            if(!b.Data) return -1;
            return ascendingOrder ? new Date(a.Data) - new Date(b.Data) : new Date(b.Data
