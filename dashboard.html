<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AprovaMaisPB - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="firebase-config.js"></script> <!-- seu Firebase -->
    <style>
        /* seu CSS atual permanece o mesmo */
    </style>
</head>
<body>
    <!-- Sidebar e main content permanecem iguais -->

    <div class="dashboard-cards">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Alunos Ativos</div>
                <div class="card-icon" style="background: rgba(26, 42, 108, 0.1); color: var(--primary);">
                    <i class="fas fa-user-graduate"></i>
                </div>
            </div>
            <div class="card-content">
                <div class="card-value" id="alunosAtivos">0</div>
                <div class="card-desc" id="alunosVariacao">0 este mês</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title">Turmas Ativas</div>
                <div class="card-icon" style="background: rgba(178, 31, 31, 0.1); color: var(--secondary);">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <div class="card-content">
                <div class="card-value" id="turmasAtivas">0</div>
                <div class="card-desc" id="turmasVariacao">0 novas</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title">Professores</div>
                <div class="card-icon" style="background: rgba(253, 187, 45, 0.1); color: var(--accent);">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
            </div>
            <div class="card-content">
                <div class="card-value" id="totalProfessores">0</div>
                <div class="card-desc" id="professoresVariacao">0 disponíveis</div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title">Receita Mensal</div>
                <div class="card-icon" style="background: rgba(40, 167, 69, 0.1); color: var(--success);">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
            <div class="card-content">
                <div class="card-value" id="receitaMensal">R$ 0,00</div>
                <div class="card-desc" id="receitaVariacao">+0% desde o mês passado</div>
            </div>
        </div>
    </div>

    <div class="charts">
        <div class="chart-container">
            <h3 class="chart-title">Desempenho Mensal de Matrículas</h3>
            <canvas id="enrollmentsChart"></canvas>
        </div>
        <div class="chart-container">
            <h3 class="chart-title">Distribuição por Turma</h3>
            <canvas id="classesChart"></canvas>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof firebase === 'undefined') return;
            const db = firebase.firestore();

            // Carregar alunos ativos e turmas
            const alunosSnapshot = await db.collection('inscricoes').get();
            const alunosAtivos = alunosSnapshot.docs.filter(doc => doc.data().status === 'ativo');
            document.getElementById('alunosAtivos').textContent = alunosAtivos.length;

            const turmasSet = new Set(alunosAtivos.map(a => a.data().turma));
            document.getElementById('turmasAtivas').textContent = turmasSet.size;

            // Professores
            const profSnapshot = await db.collection('professores').where('status', '==', 'ativo').get();
            document.getElementById('totalProfessores').textContent = profSnapshot.size;

            // Receita mensal
            const primeiroDiaMes = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const pagamentosSnapshot = await db.collection('pagamentos')
                .where('dataPagamento', '>=', primeiroDiaMes)
                .get();
            let receita = 0;
            pagamentosSnapshot.forEach(p => receita += parseFloat(p.data().valor || 0));
            document.getElementById('receitaMensal').textContent = `R$ ${receita.toFixed(2)}`;

            // Gráfico de matrículas por mês
            const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            const matriculasPorMes = new Array(12).fill(0);
            alunosSnapshot.forEach(doc => {
                const data = doc.data().criadoEm.toDate();
                matriculasPorMes[data.getMonth()] += 1;
            });
            new Chart(document.getElementById('enrollmentsChart'), {
                type: 'line',
                data: { labels: meses, datasets: [{ label: 'Matrículas', data: matriculasPorMes, borderColor: '#1a2a6c', backgroundColor: 'rgba(26,42,108,0.1)', tension: 0.3, fill:true }] },
                options: { responsive:true }
            });

            // Gráfico distribuição por turma
            const turmasLabels = Array.from(turmasSet);
            const turmasData = turmasLabels.map(t => alunosAtivos.filter(a => a.data().turma === t).length);
            new Chart(document.getElementById('classesChart'), {
                type:'doughnut',
                data:{ labels:turmasLabels, datasets:[{data:turmasData, backgroundColor:['#1a2a6c','#b21f1f','#fdbb2d','#28a745','#17a2b8']] } ],
                options:{ responsive:true }
            });
        });
    </script>
</body>
</html>
