<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload CSV Avan√ßado - Inscri√ß√µes</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
/* --- ESTILOS --- */
:root {
  --primary-color: #4CAF50;
  --secondary-color: #2196F3;
  --danger-color: #f44336;
  --light-color: #f5f5f5;
  --dark-color: #333;
  --border-radius: 8px;
  --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;line-height:1.6;color:var(--dark-color);background:#f9f9f9;padding:20px;max-width:1200px;margin:auto}
h2{color:var(--primary-color);margin-bottom:20px;text-align:center}
.card{background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:25px;margin-bottom:20px}
.upload-area{border:2px dashed #ccc;border-radius:var(--border-radius);padding:40px 20px;text-align:center;cursor:pointer;transition:.3s;margin-bottom:20px}
.upload-area:hover,.upload-area.active{border-color:var(--primary-color);background:rgba(76,175,80,0.05)}
.upload-area i{font-size:48px;color:#ccc;margin-bottom:15px;display:block}
.hidden{display:none}
.btn{background:var(--primary-color);color:#fff;border:none;padding:12px 24px;border-radius:var(--border-radius);cursor:pointer;font-size:16px;font-weight:600;transition:.3s}
.btn:hover{background:#3d8b40}
.btn:disabled{background:#ccc;cursor:not-allowed}
.btn-secondary{background:var(--secondary-color)}
.btn-secondary:hover{background:#0b7dda}
.btn-danger{background:var(--danger-color)}
.btn-danger:hover{background:#d32f2f}
.file-info{background:var(--light-color);padding:15px;border-radius:var(--border-radius);margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
.file-info .file-name{font-weight:600}
.progress-container{margin:20px 0}
#progressBar{width:100%;height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin-bottom:10px}
#progress{height:100%;width:0;background:var(--primary-color);transition:width .3s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:bold}
.summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.summary-item{background:#fff;border-radius:var(--border-radius);padding:15px;text-align:center;box-shadow:var(--box-shadow)}
.summary-value{font-size:24px;font-weight:700;margin:10px 0}
.status-error{color:var(--danger-color)}
.status-success{color:var(--primary-color)}
.error-list{max-height:200px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:var(--border-radius);padding:10px;background:#fff}
.error-item{padding:8px;border-bottom:1px solid #f0f0f0;font-size:14px}
.error-item:last-child{border-bottom:none}
</style>
</head>
<body>
<div class="card">
  <h2>Upload CSV - Sistema de Inscri√ß√µes</h2>
  <div class="upload-area" id="uploadArea">
    <i>üìÅ</i>
    <p>Arraste e solte seu arquivo CSV aqui ou clique para selecionar</p>
    <input type="file" id="csvFile" accept=".csv" class="hidden">
  </div>
  <div id="fileInfo" class="file-info hidden">
    <div>
      <span class="file-name" id="fileName"></span>
      <span class="file-size" id="fileSize"></span>
    </div>
    <button class="btn btn-danger" id="removeFile">‚úï</button>
  </div>
  <div class="actions">
    <button class="btn" id="uploadBtn" onclick="uploadCSV()" disabled>üì§ Enviar</button>
    <button class="btn btn-secondary" id="validateBtn" onclick="validateCSV()" disabled>üîç Validar</button>
  </div>
  <div class="progress-container hidden" id="progressContainer">
    <span id="progressText">0%</span>
    <div id="progressBar"><div id="progress">0%</div></div>
  </div>
</div>
<div class="card hidden" id="resultsCard">
  <h3>Resultados</h3>
  <div class="summary">
    <div class="summary-item"><div class="summary-value" id="totalCount">0</div><div>Total</div></div>
    <div class="summary-item"><div class="summary-value status-success" id="successCount">0</div><div>Sucesso</div></div>
    <div class="summary-item"><div class="summary-value status-error" id="errorCount">0</div><div>Erros</div></div>
  </div>
  <div id="status"></div>
  <div class="hidden" id="errorsCard">
    <h4>Erros Detalhados</h4>
    <div class="error-list" id="errorList"></div>
  </div>
</div>

<script>
// -------- FIREBASE --------
const firebaseConfig = {
  apiKey: "AIzaSyA8IOr3_gzyCbYqk8RH6lwwgtQLQ0u5ch0",
  authDomain: "aprovamaispb-73d39.firebaseapp.com",
  projectId: "aprovamaispb-73d39",
  storageBucket: "aprovamaispb-73d39.firebasestorage.app",
  messagingSenderId: "1052452508337",
  appId: "1:1052452508337:web:0b7919f981aa487c410890",
  measurementId: "G-M99KFX9636"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// -------- Fun√ß√µes Auxiliares --------
function formatFileSize(bytes){
  if(bytes===0) return '0 Bytes';
  const k=1024,sizes=['Bytes','KB','MB','GB'],i=Math.floor(Math.log(bytes)/Math.log(k));
  return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i];
}
function cleanCSVText(text){
  return text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').replace(/^\uFEFF/,'');
}

// -------- Upload Area --------
const uploadArea=document.getElementById('uploadArea');
uploadArea.addEventListener('click',()=>document.getElementById('csvFile').click());
document.getElementById('csvFile').addEventListener('change',e=>{
  const file=e.target.files[0]; if(file) handleFile(file);
});
uploadArea.addEventListener('dragover',e=>{e.preventDefault();uploadArea.classList.add('active')});
uploadArea.addEventListener('dragleave',()=>uploadArea.classList.remove('active'));
uploadArea.addEventListener('drop',e=>{
  e.preventDefault();uploadArea.classList.remove('active');
  const file=e.dataTransfer.files[0];
  if(file && file.name.endsWith('.csv')){
    document.getElementById('csvFile').files=e.dataTransfer.files; handleFile(file);
  } else alert('Arquivo inv√°lido');
});
document.getElementById('removeFile').addEventListener('click',()=>{
  document.getElementById('csvFile').value='';
  document.getElementById('fileInfo').classList.add('hidden');
  document.getElementById('uploadBtn').disabled=true;
  document.getElementById('validateBtn').disabled=true;
  uploadArea.classList.remove('hidden');
});

function handleFile(file){
  document.getElementById('fileName').textContent=file.name;
  document.getElementById('fileSize').textContent=' ('+formatFileSize(file.size)+')';
  document.getElementById('fileInfo').classList.remove('hidden');
  uploadArea.classList.add('hidden');
  document.getElementById('uploadBtn').disabled=false;
  document.getElementById('validateBtn').disabled=false;
}

// -------- Valida√ß√£o --------
function validateCSV(){
  const file=document.getElementById('csvFile').files[0];
  if(!file) return alert("Escolha um arquivo");
  const reader=new FileReader();
  reader.onload=e=>{
    const text=cleanCSVText(e.target.result);
    const lines=text.split('\n').filter(l=>l.trim()!=='');
    if(lines.length<2) return alert("CSV vazio");
    const headers=lines[0].split(';');
    const errors=[];
    for(let i=1;i<lines.length;i++){
      const row=lines[i].split(';');
      if(row.length!==headers.length){
        errors.push({linha:i+1,motivo:"N√∫mero de colunas incorreto"});
      }
    }
    showResults(errors,lines.length-1);
  };
  reader.readAsText(file);
}

function showResults(errors,total){
  document.getElementById('resultsCard').classList.remove('hidden');
  document.getElementById('totalCount').textContent=total;
  document.getElementById('successCount').textContent=total-errors.length;
  document.getElementById('errorCount').textContent=errors.length;
  const status=document.getElementById('status');
  if(errors.length===0){
    status.innerHTML='<p class="status-success">‚úì CSV v√°lido</p>';
    document.getElementById('errorsCard').classList.add('hidden');
  } else {
    status.innerHTML=`<p class="status-error">‚úó ${errors.length} erros</p>`;
    const list=document.getElementById('errorList'); list.innerHTML='';
    errors.forEach(e=>{
      list.innerHTML+=`<div class="error-item">Linha ${e.linha}: ${e.motivo}</div>`;
    });
    document.getElementById('errorsCard').classList.remove('hidden');
  }
}

// -------- Upload --------
async function uploadCSV(){
  const file=document.getElementById('csvFile').files[0];
  if(!file) return alert("Escolha um arquivo");
  document.getElementById('progressContainer').classList.remove('hidden');
  const reader=new FileReader();
  reader.onload=async e=>{
    const text=cleanCSVText(e.target.result);
    const lines=text.split('\n').filter(l=>l.trim()!=='');
    const headers=lines[0].split(';');
    let uploaded=0;
    for(let i=1;i<lines.length;i++){
      const row=lines[i].split(';');
      if(row.length!==headers.length) continue;
      const data={};
      headers.forEach((h,idx)=>data[h.trim()]=row[idx].trim());
      try{
        await db.collection("inscricoes").add(data);
        uploaded++;
      }catch(err){console.error("Erro Firestore:",err)}
      let percent=Math.round((i/lines.length)*100);
      document.getElementById('progress').style.width=percent+'%';
      document.getElementById('progress').textContent=percent+'%';
      document.getElementById('progressText').textContent=percent+'%';
    }
    validateCSV();
    alert(`Upload conclu√≠do: ${uploaded} registros salvos.`);
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
