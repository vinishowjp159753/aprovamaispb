<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Matrícula - AprovaMaisPB</title>
<link rel="stylesheet" href="assets/css/matricula.css">
</head>
<body>

<div class="container">
  <h1>Matrícula AprovaMaisPB</h1>

  <form id="matriculaForm">
    <label>Nome Completo *</label>
    <input type="text" id="nomeCompleto" required>

    <label>Email *</label>
    <input type="email" id="email" required>

    <label>Turma *</label>
    <select id="turma" required>
      <option value="">Selecione</option>
      <option value="Turma A - Manhã">Turma A - Manhã</option>
      <option value="Turma B - Tarde">Turma B - Tarde</option>
      <option value="Turma C - Noite">Turma C - Noite</option>
    </select>

    <button type="submit" class="btn">Realizar Matrícula e Pagar R$150</button>
  </form>
</div>

<script>
const matriculaForm = document.getElementById("matriculaForm");
matriculaForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const nomeCompleto = document.getElementById("nomeCompleto").value.trim();
  const email = document.getElementById("email").value.trim();
  const turma = document.getElementById("turma").value;

  if(!nomeCompleto || !email || !turma){
    alert("Preencha todos os campos!");
    return;
  }

  // Criar ID de matrícula temporário
  const matriculaId = Math.random().toString(36).substring(2,12);

  try {
    // Chama backend no Render
    const response = await fetch("https://pagseguro-checkout.onrender.com/create-checkout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        nome: nomeCompleto,
        email: email,
        matriculaId: matriculaId,
        valor: 150
      })
    });

    const text = await response.text();

    // Extrair URL de redirecionamento do PagSeguro
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(text,"text/xml");
    const checkoutCode = xmlDoc.getElementsByTagName("code")[0].textContent;

    const redirectURL = `https://pagseguro.uol.com.br/v2/checkout/payment.html?code=${checkoutCode}`;
    window.location.href = redirectURL;

  } catch (err) {
    console.error(err);
    alert("Erro ao criar checkout. Tente novamente.");
  }
});
</script>

</body>
</html>
