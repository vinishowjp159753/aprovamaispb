<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matricule-se - AprovaMaisPB</title>
  <link rel="stylesheet" href="./assets/css/style.css" />
  <link rel="icon" type="image/png" href="./assets/img/logo_aprovamaispb.png" />
  <style>
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(100%);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    .notification.success {
      background: #28a745;
    }
    .notification.error {
      background: #dc3545;
    }
    .whatsapp-btn {
      background-color: #25D366 !important;
      margin-top: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .whatsapp-btn:hover {
      background-color: #128C7E !important;
      transform: translateY(-2px);
    }
    .input-group .error {
      color: #dc3545;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    .input-group.invalid input,
    .input-group.invalid select {
      border-color: #dc3545;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }
    .loading {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand">
        <img src="./assets/img/logo_aprovamaispb.png" alt="Logo" />
        <span>AprovaMaisPB</span>
      </div>
      <ul class="menu">
        <li><a href="index.html">In√≠cio</a></li>
        <li><a href="matricula.html">Matricule-se</a></li>
        <li><a href="professores.html">Professores</a></li>
        <li><a href="login.html">Dashboard</a></li>
      </ul>
      <button class="hamburger" aria-label="menu" onclick="toggleMenu()">‚ò∞</button>
    </nav>
  </header>

  <main class="matricula-container">
    <h1>Formul√°rio de Matr√≠cula</h1>
    <div class="form-card">
      <form id="registration-form">
        <div class="input-group">
          <label for="name">Nome completo</label>
          <input type="text" id="name" required />
          <div class="error" id="name-error">Por favor, informe seu nome completo</div>
        </div>
        
        <div class="row-two">
          <div class="input-group">
            <label for="email">E-mail</label>
            <input type="email" id="email" required />
            <div class="error" id="email-error">Por favor, informe um e-mail v√°lido</div>
          </div>
          <div class="input-group">
            <label for="phone">Telefone</label>
            <input type="tel" id="phone" required placeholder="(83) 99999-9999" />
            <div class="error" id="phone-error">Por favor, informe um telefone v√°lido</div>
          </div>
        </div>
        
        <div class="row-two">
          <div class="input-group">
            <label for="cpf">CPF</label>
            <input type="text" id="cpf" required placeholder="000.000.000-00" />
            <div class="error" id="cpf-error">Por favor, informe um CPF v√°lido</div>
          </div>
          <div class="input-group">
            <label for="course">Curso desejado</label>
            <select id="course" required>
              <option value="">Selecione um curso</option>
              <option value="Aul√£o do ENEM">Aul√£o do ENEM</option>
            </select>
            <div class="error" id="course-error">Por favor, selecione um curso</div>
          </div>
        </div>
        
        <div class="actions">
          <button type="submit" class="btn-modern">üöÄ Enviar Inscri√ß√£o</button>
          <div id="loading" class="loading" style="display:none"></div>
        </div>
        
        <div id="whatsapp-container" style="margin-top: 20px; display: none;"></div>
      </form>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>AprovaMaisPB</h3>
        <p>O curso preparat√≥rio inteligente para o ENEM</p>
      </div>
      <div class="footer-section">
        <h3>Contato</h3>
        <p>Email: contato@aprovamaispb.com</p>
        <p>Telefone: (83) 99999-9999</p>
      </div>
      <div class="footer-section">
        <h3>Redes Sociais</h3>
        <div class="social-icons">
          <a href="#">Instagram</a>
          <a href="#">Facebook</a>
          <a href="#">YouTube</a>
        </div>
      </div>
    </div>
    <p class="copyright">¬© 2025 AprovaMaisPB - Todos os direitos reservados.</p>
  </footer>

<script type="module">
  import { salvarInscricao } from "./assets/js/firebase.js";
  import { enviarEmail } from "./assets/js/email.js";

  function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    
    let soma = 0;
    for (let i = 0; i < 9; i++) {
      soma += parseInt(cpf.charAt(i)) * (10 - i);
    }
    
    let resto = 11 - (soma % 11);
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.charAt(9))) return false;
    
    soma = 0;
    for (let i = 0; i < 10; i++) {
      soma += parseInt(cpf.charAt(i)) * (11 - i);
    }
    
    resto = 11 - (soma % 11);
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.charAt(10))) return false;
    
    return true;
  }

  function formatarCPF(cpf) {
    return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
  }

  function gerarSenha(tamanho = 8) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    return Array.from({ length: tamanho }, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
  }

  function mostrarNotificacao(mensagem, tipo = "success") {
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${tipo}`;
    notification.innerHTML = `
      <span>${mensagem}</span>
      <button onclick="this.parentElement.remove()">√ó</button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    }, 5000);
  }

  function aplicarMascaraCPF() {
    const cpfInput = document.getElementById("cpf");
    if (cpfInput) {
      cpfInput.addEventListener("input", function(e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 11) value = value.slice(0, 11);
        
        if (value.length <= 11) {
          value = value.replace(/(\d{3})(\d)/, "$1.$2");
          value = value.replace(/(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
          value = value.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3-$4");
        }
        
        e.target.value = value;
      });
    }
  }

  function validarEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
  }

  function validarTelefone(telefone) {
    const numeros = telefone.replace(/\D/g, '');
    return numeros.length >= 10;
  }

  function validarNome(nome) {
    return nome.trim().length >= 3;
  }

  function mostrarErro(campoId, mensagem) {
    const campo = document.getElementById(campoId);
    const errorElement = document.getElementById(`${campoId}-error`);
    const inputGroup = campo.closest('.input-group');
    
    if (errorElement) {
      errorElement.textContent = mensagem;
      errorElement.style.display = 'block';
    }
    
    if (inputGroup) {
      inputGroup.classList.add('invalid');
    }
  }

  function limparErro(campoId) {
    const campo = document.getElementById(campoId);
    const errorElement = document.getElementById(`${campoId}-error`);
    const inputGroup = campo.closest('.input-group');
    
    if (errorElement) {
      errorElement.style.display = 'none';
    }
    
    if (inputGroup) {
      inputGroup.classList.remove('invalid');
    }
  }

  function validarFormulario() {
    let valido = true;
    
    const nome = document.getElementById("name").value;
    if (!validarNome(nome)) {
      mostrarErro('name', 'Por favor, informe seu nome completo');
      valido = false;
    } else {
      limparErro('name');
    }
    
    const email = document.getElementById("email").value;
    if (!validarEmail(email)) {
      mostrarErro('email', 'Por favor, informe um e-mail v√°lido');
      valido = false;
    } else {
      limparErro('email');
    }
    
    const telefone = document.getElementById("phone").value;
    if (!validarTelefone(telefone)) {
      mostrarErro('phone', 'Por favor, informe um telefone v√°lido');
      valido = false;
    } else {
      limparErro('phone');
    }
    
    const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
    if (!validarCPF(cpf)) {
      mostrarErro('cpf', 'Por favor, informe um CPF v√°lido');
      valido = false;
    } else {
      limparErro('cpf');
    }
    
    const curso = document.getElementById("course").value;
    if (!curso) {
      mostrarErro('course', 'Por favor, selecione um curso');
      valido = false;
    } else {
      limparErro('course');
    }
    
    return valido;
  }

  document.addEventListener('DOMContentLoaded', function() {
    aplicarMascaraCPF();
    
    const campos = ['name', 'email', 'phone', 'cpf', 'course'];
    campos.forEach(campoId => {
      const campo = document.getElementById(campoId);
      if (campo) {
        campo.addEventListener('blur', () => {
          if (campoId === 'cpf') {
            const cpf = campo.value.replace(/\D/g, "");
            if (cpf && !validarCPF(cpf)) {
              mostrarErro(campoId, 'Por favor, informe um CPF v√°lido');
            } else {
              limparErro(campoId);
            }
          } else if (campoId === 'email' && campo.value) {
            if (!validarEmail(campo.value)) {
              mostrarErro(campoId, 'Por favor, informe um e-mail v√°lido');
            } else {
              limparErro(campoId);
            }
          } else if (campoId === 'phone' && campo.value) {
            if (!validarTelefone(campo.value)) {
              mostrarErro(campoId, 'Por favor, informe um telefone v√°lido');
            } else {
              limparErro(campoId);
            }
          } else if (campoId === 'name' && campo.value) {
            if (!validarNome(campo.value)) {
              mostrarErro(campoId, 'Por favor, informe seu nome completo');
            } else {
              limparErro(campoId);
            }
          }
        });
      }
    });
    
    const form = document.getElementById("registration-form");
    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        if (!validarFormulario()) {
          mostrarNotificacao("Por favor, corrija os erros no formul√°rio.", "error");
          return;
        }
        
        const loading = document.getElementById("loading");
        const submitBtn = form.querySelector('button[type="submit"]');
        
        if (loading) loading.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
        
        const cpf = document.getElementById("cpf").value.replace(/\D/g, "");
        
        const dados = {
          name: document.getElementById("name").value,
          email: document.getElementById("email").value,
          phone: document.getElementById("phone").value,
          cpf: cpf,
          course: document.getElementById("course").value,
          numeroPedido: Math.floor(100000 + Math.random() * 900000),
          senha: gerarSenha(),
          criadoEm: new Date().toISOString(),
          status: "pendente"
        };
        
        try {
          await salvarInscricao(dados);
          await enviarEmail(dados);
          
          mostrarNotificacao("‚úÖ Inscri√ß√£o conclu√≠da! Seus dados foram enviados para " + dados.email, "success");
          form.reset();
          
          const msg = `Ol√°, meu nome √© ${dados.name}.%0A
Me inscrevi no curso *${dados.course}*.%0A
N√∫mero do pedido: ${dados.numeroPedido}%0A
CPF: ${formatarCPF(dados.cpf)}%0A
Telefone: ${dados.phone}%0A
Gostaria de confirmar o pagamento da matr√≠cula via WhatsApp.`;
          
          const numeroWhats = "5583999999999";
          const url = `https://wa.me/${numeroWhats}?text=${encodeURIComponent(msg)}`;
          
          const whatsappContainer = document.getElementById("whatsapp-container");
          if (whatsappContainer) {
            whatsappContainer.innerHTML = '';
            
            const btnWpp = document.createElement("a");
            btnWpp.href = url;
            btnWpp.target = "_blank";
            btnWpp.className = "btn-modern whatsapp-btn";
            btnWpp.innerHTML = "üì≤ Confirmar pagamento no WhatsApp";
            whatsappContainer.appendChild(btnWpp);
            whatsappContainer.style.display = "block";
          }
        } catch (err) {
          console.error("Erro na matr√≠cula:", err);
          let mensagemError = "‚ùå Erro ao salvar inscri√ß√£o. Tente novamente.";
          
          if (err.message.includes("permission-denied")) {
            mensagemError = "‚ùå Erro de permiss√£o. Verifique as regras do Firebase.";
          } else if (err.message.includes("network")) {
            mensagemError = "‚ùå Erro de conex√£o. Verifique sua internet.";
          }
          
          mostrarNotificacao(mensagemError, "error");
        } finally {
          if (loading) loading.style.display = "none";
          submitBtn.disabled = false;
          submitBtn.textContent = "üöÄ Enviar Inscri√ß√£o";
        }
      });
    }
  });
</script>

<script>
function toggleMenu(){
  document.querySelector('.menu').classList.toggle('open');
}
</script>
</body>
</html>
